<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question {{ q_num }} - Speaking Assessment</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'speaking/css/style.css' %}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            color: white;
        }
        
        header h1 {
            font-size: 2rem;
        }
        
        main {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: 600px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        
        .progress {
            margin-bottom: 30px;
            font-size: 1.1rem;
            color: #666;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        
        .question-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .question-card h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .instruction {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .question-content {
            font-size: 1.2rem;
        }
        
        .words-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }
        
        .word-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .word-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .word-header h3 {
            color: #333;
            font-size: 1.3rem;
        }
        
        .word-status {
            font-size: 1rem;
            padding: 5px 15px;
            border-radius: 20px;
            background: #f0f0f0;
            color: #666;
        }
        
        .word-status.recorded {
            background: #d4edda;
            color: #155724;
        }
        
        .word-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .word-btn {
            padding: 10px 20px;
            font-size: 1rem;
        }
        
        .word {
            background: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 1.3rem;
            font-weight: 500;
            color: #667eea;
        }
        
        .phrases-list {
            margin: 20px 0;
        }
        
        .phrase {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            font-size: 1.2rem;
            border-left: 4px solid #667eea;
        }
        
        .sentence-box {
            background: #e3f2fd;
            padding: 25px;
            border-radius: 10px;
            font-size: 1.4rem;
            border-left: 5px solid #2196f3;
            margin: 20px 0;
            text-align: center;
        }
        
        .incorrect-sentence {
            background: #ffebee;
            padding: 15px;
            border-radius: 10px;
            color: #c62828;
            margin: 10px 0;
            font-size: 1.2rem;
        }
        
        .recording-section {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .microphone-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .mic-icon {
            font-size: 3rem;
            transition: color 0.3s;
        }
        
        .status-text {
            font-size: 1.2rem;
            color: #666;
        }
        
        .recording-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        button {
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .record-btn {
            background: #f44336;
            color: white;
        }
        
        .record-btn:hover:not(:disabled) {
            background: #d32f2f;
            transform: scale(1.05);
        }
        
        .stop-btn {
            background: #ff9800;
            color: white;
        }
        
        .stop-btn:hover:not(:disabled) {
            background: #f57c00;
            transform: scale(1.05);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 50px;
            font-size: 1.2rem;
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
        }
        
        .success-message {
            color: #4caf50;
            font-size: 1.2rem;
            margin: 20px 0;
        }
        
        .submit-section {
            margin-top: 30px;
        }
        
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: #fff3e0;
            border-radius: 10px;
        }
        
        .word-tile {
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            border: 2px solid #ff9800;
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .submit-all-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 50px;
            font-size: 1.2rem;
            margin-top: 20px;
            width: 100%;
        }
        
        .submit-all-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>


    <div id="urls" 
     data-question-url="{% url 'speaking:question' 0 %}"
     data-submit-url="{% url 'speaking:submit_recording' %}"
     data-process-url="{% url 'speaking:process_results' %}"
     data-result-url="{% url 'speaking:result' %}"
     style="display: none;"></div>   

    <div class="container">
        <header>
            <h1>üéì AI Speaking Assessment</h1>
        </header>
        
        <main>
            <div class="progress">
                Question {{ q_num }} of 5
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ q_num }}0%"></div>
                </div>
            </div>
            
            <div class="question-card">
                <h2>{{ question.title }}</h2>
                <div class="instruction">{{ question.instruction }}</div>
                
                <div class="question-content">
                    <!-- Question 1: 5 Separate Recording Buttons -->
                    {% if q_num == 1 %}
                    <div class="words-list" id="q1-words">
                        {% for word in question.words %}
                        <div class="word-item" id="word-{{ forloop.counter }}">
                            <div class="word-header">
                                <h3>Word {{ forloop.counter }}: {{ word }}</h3>
                                <span class="word-status" id="status-{{ forloop.counter }}">‚è∫Ô∏è Not recorded</span>
                            </div>
                            <div class="word-controls">
                                <button class="record-btn word-btn" onclick="startWordRecording({{ forloop.counter }})" 
                                        id="record-{{ forloop.counter }}">Record Word {{ forloop.counter }}</button>
                                <button class="stop-btn word-btn" onclick="stopWordRecording({{ forloop.counter }})" 
                                        id="stop-{{ forloop.counter }}" disabled>Stop</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="submit-all-btn" onclick="submitAllWords()" id="submitAllBtn" disabled>Submit All Words</button>
                    {% endif %}
                    
                    <!-- Question 2: Word Bank -->
                    {% if q_num == 2 and question.words %}
                        <div class="word-bank">
                            {% for word in question.words %}
                                <span class="word-tile">{{ word }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Question 3: Phrases -->
                    {% if q_num == 3 and question.phrases %}
                        <div class="phrases-list">
                            {% for phrase in question.phrases %}
                                <div class="phrase">‚Ä¢ {{ phrase }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Question 4: Sentence -->
                    {% if q_num == 4 and question.sentence %}
                        <div class="sentence-box">
                            {{ question.sentence }}
                        </div>
                    {% endif %}
                    
                    <!-- Question 5: Incorrect Sentence Only -->
                    {% if q_num == 5 and question.incorrect_sentence %}
                        <div class="incorrect-sentence">
                            <strong>Incorrect:</strong> {{ question.incorrect_sentence }}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Recording Section for Q2-Q5 -->
                {% if q_num != 1 %}
                <div class="recording-section">
                    <div class="microphone-status">
                        <div class="mic-icon" id="micIcon">üé§</div>
                        <div class="status-text" id="statusText">Ready to record</div>
                    </div>
                    
                    <div class="recording-controls">
                        <button class="record-btn" onclick="startRecording()" id="recordBtn">
                            Start Recording
                        </button>
                        <button class="stop-btn" onclick="stopRecording()" id="stopBtn" disabled>
                            Stop Recording
                        </button>
                    </div>
                    
                    <div class="timer" id="timer">00:00</div>
                    
                    <div class="submit-section" style="display: none;" id="submitSection">
                        <p class="success-message">‚úì Recording complete!</p>
                        <button class="submit-btn" onclick="submitRecording()" id="submitBtn">
                            Submit & Continue ‚Üí
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </main>
        
        <footer>
            <p>¬© 2026 Speaking Assessment System | Research Purpose</p>
        </footer>
    </div>

    <script>
        // Get URLs from hidden div
                // Get URLs from hidden div
        const urls = document.getElementById('urls');
        const questionBaseUrl = urls ? urls.dataset.questionUrl : 'NOT FOUND';
        const submitUrl = urls ? urls.dataset.submitUrl : 'NOT FOUND';
        const processUrl = urls ? urls.dataset.processUrl : 'NOT FOUND';
        const resultUrl = urls ? urls.dataset.resultUrl : 'NOT FOUND';

        // ADD THESE DEBUG LINES
        console.log('========== URL DEBUG ==========');
        console.log('questionBaseUrl:', questionBaseUrl);
        console.log('submitUrl:', submitUrl);
        console.log('processUrl:', processUrl);
        console.log('resultUrl:', resultUrl);
        console.log('===============================');
        // Global variables
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let timerInterval;
        let seconds = 0;
        const qNum = {{ q_num }};
        
        // Q1 specific variables
        let currentWord = null;
        let wordRecordings = {1: null, 2: null, 3: null, 4: null, 5: null};
        let wordMediaRecorder = {1: null, 2: null, 3: null, 4: null, 5: null};
        let wordStreams = {1: null, 2: null, 3: null, 4: null, 5: null};
        
        // ========== Q1: Individual Word Recording Functions ==========
        function startWordRecording(wordNum) {
            currentWord = wordNum;
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    // Store stream for cleanup
                    wordStreams[wordNum] = stream;
                    
                    wordMediaRecorder[wordNum] = new MediaRecorder(stream);
                    let chunks = [];
                    
                    wordMediaRecorder[wordNum].ondataavailable = event => {
                        if (event.data.size > 0) {
                            chunks.push(event.data);
                        }
                    };
                    
                    wordMediaRecorder[wordNum].onstop = () => {
                        if (chunks.length === 0) {
                            alert('No audio recorded! Please check your microphone.');
                            return;
                        }
                        
                        const blob = new Blob(chunks, { type: 'audio/wav' });
                        
                        if (blob.size < 1000) {
                            alert('Recording too short or no audio detected!');
                            return;
                        }
                        
                        // Save recording
                        wordRecordings[wordNum] = blob;
                        
                        // Update UI
                        document.getElementById(`status-${wordNum}`).innerHTML = '‚úÖ Recorded';
                        document.getElementById(`status-${wordNum}`).className = 'word-status recorded';
                        document.getElementById(`record-${wordNum}`).disabled = false;
                        document.getElementById(`stop-${wordNum}`).disabled = true;
                        
                        // Check if all words recorded
                        let allRecorded = true;
                        for (let i = 1; i <= 5; i++) {
                            if (!wordRecordings[i]) {
                                allRecorded = false;
                                break;
                            }
                        }
                        if (allRecorded) {
                            document.getElementById('submitAllBtn').disabled = false;
                        }
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    wordMediaRecorder[wordNum].start();
                    
                    // Update UI
                    document.getElementById(`record-${wordNum}`).disabled = true;
                    document.getElementById(`stop-${wordNum}`).disabled = false;
                    document.getElementById(`status-${wordNum}`).innerHTML = 'üî¥ Recording...';
                    document.getElementById(`status-${wordNum}`).className = 'word-status';
                })
                .catch(error => {
                    alert('Microphone error: ' + error.message);
                });
        }
        
        function stopWordRecording(wordNum) {
            if (wordMediaRecorder[wordNum] && wordMediaRecorder[wordNum].state !== 'inactive') {
                wordMediaRecorder[wordNum].stop();
            }
        }
        
       function submitAllWords() {
    console.log('üöÄ submitAllWords STARTED');
    
    // Check if all words are recorded
    for (let i = 1; i <= 5; i++) {
        if (!wordRecordings[i]) {
            alert(`Please record Word ${i} first`);
            return;
        }
    }
    
    // Disable button and show uploading status
    document.getElementById('submitAllBtn').disabled = true;
    document.getElementById('submitAllBtn').textContent = 'Uploading 0/5...';
    
    // Upload each word
    let uploaded = 0;
    let errors = 0;
    
    for (let i = 1; i <= 5; i++) {
        const formData = new FormData();
        formData.append('audio', wordRecordings[i], `word${i}.wav`);
        formData.append('q_num', 1);
        formData.append('word_num', i);
        
        console.log(`üì§ Uploading word ${i}...`);
        
        fetch(submitUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            uploaded++;
            document.getElementById('submitAllBtn').textContent = `Uploading ${uploaded}/5...`;
            console.log(`‚úÖ Word ${i} uploaded successfully`);
            
            if (uploaded === 5) {
                console.log('üéØ ALL WORDS UPLOADED! Redirecting to: /speaking/question/2/');
                setTimeout(() => {
                    window.location.href = '/speaking/question/2/';
                }, 500); // Small delay to ensure everything is processed
            }
        })
        .catch(error => {
            errors++;
            console.error(`‚ùå Upload failed for word ${i}:`, error);
            alert('Upload failed for word ' + i + ': ' + error.message);
            document.getElementById('submitAllBtn').disabled = false;
            document.getElementById('submitAllBtn').textContent = 'Submit All Words';
        });
    }
}
        
        // ========== Q2-Q5: Regular Recording Functions ==========
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        if (audioChunks.length === 0) {
                            alert('No audio recorded! Please check your microphone.');
                            return;
                        }
                        
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        
                        if (audioBlob.size < 1000) {
                            alert('Recording too short or no audio detected!');
                            return;
                        }
                        
                        document.getElementById('submitSection').style.display = 'block';
                        mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    
                    document.getElementById('recordBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('micIcon').style.color = '#ff4444';
                    document.getElementById('statusText').textContent = 'Recording...';
                    
                    startTimer();
                })
                .catch(error => {
                    alert('Microphone error: ' + error.message);
                });
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('micIcon').style.color = '';
                document.getElementById('statusText').textContent = 'Recording complete';
                
                stopTimer();
            }
        }
        
        function startTimer() {
            seconds = 0;
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
        }
        
        function updateTimerDisplay() {
            seconds++;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timer').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function submitRecording() {
            const formData = new FormData();
            formData.append('audio', audioBlob, `recording_${qNum}.wav`);
            formData.append('q_num', qNum);
            
            document.getElementById('submitBtn').textContent = 'Uploading...';
            document.getElementById('submitBtn').disabled = true;
            
            fetch(submitUrl,{
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.next_question) {
                        window.location.href =  '/speaking/question/' + data.next_question + '/';
                    } else {
                        processResults();
                    }
                } else {
                    alert('Error: ' + data.error);
                    document.getElementById('submitBtn').textContent = 'Submit & Continue ‚Üí';
                    document.getElementById('submitBtn').disabled = false;
                }
            })
            .catch(error => {
                alert('Upload failed: ' + error.message);
                document.getElementById('submitBtn').textContent = 'Submit & Continue ‚Üí';
                document.getElementById('submitBtn').disabled = false;
            });
        }
        
        function processResults() {
           fetch(processUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                   window.location.href = '{% url "speaking:result" %}';
                } else {
                    alert('Error processing results: ' + data.error);
                }
            })
            .catch(error => {
                alert('Failed to process results: ' + error.message);
            });
        }
    </script>
</body>
</html>