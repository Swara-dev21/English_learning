{% extends 'writing/base.html' %}
{% load static %}

{% block title %}Question {{ question_number }} - Writing Test{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #4f46e5;
        --primary-dark: #7c3aed;
        --primary-gradient: linear-gradient(135deg, #4f46e5, #7c3aed);
        --primary-light: #eef2ff;
        --accent: #a78bfa;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
    }

    .writing-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px 15px;
    }
    
    .progress-container {
        background: white;
        border-radius: 16px;
        padding: 20px 25px;
        box-shadow: 0 10px 25px -10px rgba(79, 70, 229, 0.15);
        margin-bottom: 25px;
        border: 1px solid rgba(79, 70, 229, 0.1);
    }
    
    .progress {
        height: 10px;
        border-radius: 8px;
        background-color: #e9ecef;
        margin-top: 12px;
        overflow: hidden;
    }
    
    .progress-bar {
        background: var(--primary-gradient);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .question-card {
        border: none;
        border-radius: 24px;
        box-shadow: 0 20px 40px -15px rgba(79, 70, 229, 0.25);
        overflow: hidden;
        border: 1px solid rgba(79, 70, 229, 0.1);
        animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .question-header {
        background: var(--primary-gradient);
        color: white;
        padding: 25px;
        position: relative;
        overflow: hidden;
    }

    .question-header::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 60%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .question-body {
        padding: 30px;
    }
    
    .answer-box {
        border: 2px solid #e9ecef;
        border-radius: 16px;
        padding: 20px;
        margin: 20px 0;
        transition: all 0.3s ease;
        background: white;
    }
    
    .answer-box:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }
    
    .answer-textarea {
        width: 100%;
        border: none;
        outline: none;
        resize: vertical;
        min-height: 150px;
        font-size: 18px;
        line-height: 1.6;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 10px;
        color: #1e293b;
    }
    
    .word-counter {
        text-align: right;
        color: #6c757d;
        font-size: 16px;
        margin-top: 10px;
        font-weight: 500;
        padding-top: 10px;
        border-top: 1px dashed #e9ecef;
    }
    
    .hint-box {
        background-color: var(--primary-light);
        border: 1px solid rgba(79, 70, 229, 0.3);
        border-radius: 12px;
        padding: 15px 20px;
        margin: 15px 0;
        font-size: 16px;
        border-left: 4px solid var(--primary);
    }
    
    /* ===== IMPROVED QUESTION DISPLAY STYLES ===== */
    .question-display {
        background: linear-gradient(135deg, #f8fafc, #ffffff);
        border-radius: 20px;
        padding: 30px;
        margin: 20px 0;
        border: 2px solid var(--primary);
        box-shadow: 0 10px 30px rgba(79, 70, 229, 0.15);
        position: relative;
        overflow: hidden;
    }

    .question-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 8px;
        height: 100%;
        background: var(--primary-gradient);
    }

    .question-display h5 {
        font-size: 22px;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 3px solid var(--primary-light);
        padding-bottom: 12px;
    }

    .question-display h5 i {
        color: var(--primary);
        margin-right: 10px;
        font-size: 24px;
    }

    .question-text {
        font-size: 20px;
        font-weight: 600;
        line-height: 1.7;
        color: #1e293b;
        background: white;
        padding: 20px;
        border-radius: 16px;
        border: 1px solid rgba(79, 70, 229, 0.2);
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    .question-text .sentence-item {
        font-size: 20px;
        font-weight: 500;
        padding: 12px 15px;
        margin-bottom: 10px;
        background: #f8fafc;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
    }

    .question-text .sentence-item strong {
        color: var(--primary-dark);
        font-weight: 700;
        margin-right: 10px;
    }

    .question-text .blank-item {
        font-size: 20px;
        font-weight: 600;
        padding: 12px 15px;
        margin-bottom: 10px;
        background: #fff3e0;
        border-radius: 12px;
        border-left: 4px solid var(--warning);
    }

    .question-text .blank-item span {
        color: var(--primary-dark);
        font-weight: 700;
    }

    .clue-words-badge {
        display: inline-block;
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        font-size: 18px;
        padding: 10px 20px;
        border-radius: 50px;
        margin: 5px;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .format-box {
        background: #eef2ff;
        border-radius: 14px;
        padding: 15px 20px;
        margin-top: 20px;
        border: 1px dashed var(--primary);
    }

    .format-box strong {
        color: var(--primary-dark);
        font-size: 16px;
        font-weight: 700;
    }

    .format-box .format-example {
        background: white;
        padding: 8px 15px;
        border-radius: 30px;
        display: inline-block;
        margin-left: 10px;
        color: var(--primary);
        font-weight: 600;
        border: 1px solid var(--primary);
    }

    .mcq-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 18px;
    }
    
    .mcq-table th {
        background: var(--primary-gradient);
        color: white;
        font-weight: 700;
        padding: 15px;
        font-size: 20px;
    }
    
    .mcq-table td {
        padding: 15px;
        border: 2px solid #e9ecef;
        font-weight: 500;
    }
    
    .mcq-table .correct-option {
        background-color: rgba(16, 185, 129, 0.15);
        border-left: 5px solid var(--success);
        font-weight: 700;
        color: #065f46;
    }
    
    /* Auto-save indicator */
    .auto-save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 14px;
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        animation: fadeInOut 2s ease;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(20px); }
        10% { opacity: 1; transform: translateY(0); }
        90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
    }
    
    /* Question type badge */
    .question-type-badge {
        font-size: 18px;
        font-weight: 700;
        padding: 10px 25px;
        border-radius: 50px;
        background: var(--primary-gradient) !important;
        color: white;
        box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4);
        display: inline-flex;
        align-items: center;
        letter-spacing: 0.5px;
    }
    
    /* Button styling */
    .btn {
        font-size: 16px;
        padding: 12px 30px;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-primary {
        background: var(--primary-gradient);
        border: none;
        color: white;
        box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 25px rgba(79, 70, 229, 0.4);
        background: linear-gradient(135deg, #7c3aed, #4f46e5);
    }

    .btn-outline-primary {
        background: white;
        border: 2px solid var(--primary);
        color: var(--primary);
    }

    .btn-outline-primary:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
        border-color: var(--primary-dark);
    }

    .btn-warning {
        background: var(--warning);
        border: none;
        color: white;
        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 25px rgba(245, 158, 11, 0.4);
    }
    
    /* Header text */
    .question-header h3 {
        font-size: 26px;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .badge {
        font-size: 18px;
        padding: 8px 20px;
        border-radius: 50px;
        font-weight: 700;
        background: rgba(255,255,255,0.2) !important;
        color: white;
        border: 2px solid rgba(255,255,255,0.3);
        position: relative;
        z-index: 1;
    }
    
    /* Progress text */
    .progress-text {
        font-size: 16px;
        font-weight: 600;
    }

    .progress-text:first-child {
        color: var(--primary);
    }

    .progress-text:last-child {
        color: var(--primary-dark);
    }
    
    /* Requirements text */
    .requirements {
        font-size: 16px;
        color: #1e293b;
        margin-top: 20px;
        padding: 15px 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 2px solid var(--primary-light);
        font-weight: 500;
    }

    .requirements i {
        color: var(--primary);
    }
    
    .requirements ul li {
        font-weight: 500;
        margin-bottom: 8px;
    }
    
    /* Card Footer */
    .card-footer {
        padding: 20px 30px;
        background: #f8fafc;
        border-top: 1px solid rgba(79, 70, 229, 0.1);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .writing-container {
            padding: 15px;
        }

        .progress-container {
            padding: 15px 20px;
        }

        .question-header {
            padding: 20px;
        }

        .question-header h3 {
            font-size: 22px;
        }

        .question-body {
            padding: 20px;
        }

        .badge {
            font-size: 16px;
            padding: 6px 15px;
        }

        .btn {
            padding: 10px 20px;
            font-size: 15px;
        }

        .card-footer {
            padding: 15px 20px;
        }
        
        .question-display {
            padding: 20px;
        }
        
        .question-text {
            font-size: 18px;
        }
        
        .question-text .sentence-item {
            font-size: 18px;
        }
        
        .mcq-table {
            font-size: 16px;
        }
        
        .mcq-table th {
            font-size: 18px;
        }
    }

    @media (max-width: 480px) {
        .progress-container .d-flex {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start !important;
        }

        .question-header .d-flex {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start !important;
        }

        .answer-textarea {
            font-size: 16px;
            min-height: 120px;
        }
        
        .question-text {
            font-size: 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="writing-container">
    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="progress-text">
                    <i class="fas fa-question-circle me-1" style="color: var(--primary);"></i>
                    Question {{ question_number }} of {{ total_questions }}
                </span>
                <span class="text-muted ms-3">
                    <i class="fas fa-pencil-alt me-1" style="color: var(--primary);"></i>
                    Writing Test
                </span>
            </div>
            <span class="progress-text">
                <i class="fas fa-chart-pie me-1" style="color: var(--primary);"></i>
                {{ progress_percentage }}% Complete
            </span>
        </div>
        <div class="progress">
            <div class="progress-bar" role="progressbar" 
                 style="width: {{ progress_percentage }}%" 
                 aria-valuenow="{{ progress_percentage }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
            </div>
        </div>
    </div>
    
    <!-- Main Question Card -->
    <div class="question-card">
        <!-- Header -->
        <div class="question-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">
                    <i class="fas fa-edit me-2"></i>Writing Test
                </h3>
                <div class="badge">
                    Q{{ question_number }}/{{ total_questions }}
                </div>
            </div>
        </div>
        
        <div class="question-body">
            <!-- Question Type Badge -->
            <div class="mb-4">
                <span class="question-type-badge">
                    <i class="fas fa-tag me-2"></i>
                    {{ question.get_question_type_display }}
                </span>
            </div>

            <!-- ===== HARDCODED QUESTIONS BY TYPE - ENHANCED VISIBILITY ===== -->

            <!-- Q1: Fill in the Blanks -->
            {% if question.question_type == 'fill_blanks' and question_number == 1 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-puzzle-piece"></i>
                    Complete these sentences:
                </h5>
                
                <div class="question-text">
                    <div class="blank-item">
                        <span>1.</span> She <strong class="text-primary">___ (go/goes)</strong> to college every day.
                    </div>
                    <div class="blank-item">
                        <span>2.</span> The students <strong class="text-primary">___ (is/are)</strong> in the classroom.
                    </div>
                    <div class="blank-item">
                        <span>3.</span> This is <strong class="text-primary">___ (a / an)</strong> useful book.
                    </div>
                </div>
                
                <div class="format-box">
                    <strong><i class="fas fa-info-circle me-2"></i>FORMAT:</strong>
                    <span class="format-example">Write answers separated by commas (e.g., goes, is, an)</span>
                </div>
            </div>
            {% endif %}

            <!-- Q2: Sentence Order -->
            {% if question.question_type == 'sentence_order' and question_number == 2 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-sort-amount-down"></i>
                    Arrange these sentences in logical order:
                </h5>
                
                <div class="question-text">
                    <div class="sentence-item">
                        <strong>A.</strong> We submitted the assignment.
                    </div>
                    <div class="sentence-item">
                        <strong>B.</strong> The teacher explained the topic.
                    </div>
                    <div class="sentence-item">
                        <strong>C.</strong> The class started at ten.
                    </div>
                </div>
                
                <div class="hint-box">
                    <i class="fas fa-lightbulb me-2" style="color: var(--primary); font-size: 20px;"></i>
                    <strong>Hint:</strong> Think about what happens first, second, and last.
                </div>
                
                <div class="format-box">
                    <strong><i class="fas fa-info-circle me-2"></i>FORMAT:</strong>
                    <span class="format-example">Write letters in order (e.g., A, B, C)</span>
                </div>
            </div>
            {% endif %}

            <!-- Q3: Sentence Rewrite -->
            {% if question.question_type == 'sentence_rewrite' and question_number == 3 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-spell-check"></i>
                    Rewrite the sentence correctly:
                </h5>
                
                <div class="question-text" style="background: #fff3e0;">
                    <div style="font-size: 22px; font-weight: 700; color: #b45309; margin-bottom: 15px;">
                        <i class="fas fa-quote-left me-2"></i>Original Sentence:
                    </div>
                    <div style="font-size: 20px; font-weight: 600; font-style: italic; color: #1e293b; background: white; padding: 20px; border-radius: 12px; border: 2px dashed #f59e0b;">
                        "comunication skills are important however students often ignore punctution grammer and clarity"
                    </div>
                </div>
                
                <div class="alert alert-warning mt-4" style="font-size: 18px; font-weight: 500;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Check for:</strong> Spelling, punctuation, capitalization, and grammar
                </div>
            </div>
            {% endif %}

            <!-- Q4: Spelling MCQ -->
            <!-- Q4: Spelling MCQ - FIXED VERSION with no background colors -->
{% if question.question_type == 'spelling_mcq' and question_number == 4 %}
<div class="question-display">
    <h5>
        <i class="fas fa-check-double"></i>
        Choose the correctly spelled word:
    </h5>
    
    <table class="mcq-table">
        <tr>
            <th>Q1</th>
            <td>a) recieve</td>
            <td>b) receive</td>
            <td>c) recite</td>
            <td>d) receieve</td>
        </tr>
        <tr>
            <th>Q2</th>
            <td>a) definately</td>
            <td>b) definitely</td>
            <td>c) diffidently</td>
            <td>d) defenetly</td>
        </tr>
        <tr>
            <th>Q3</th>
            <td>a) seperate</td>
            <td>b) separate</td>
            <td>c) sepereta</td>
            <td>d) seprate</td>
        </tr>
    </table>
    
    <div class="format-box">
        <strong><i class="fas fa-info-circle me-2"></i>FORMAT:</strong>
        <span class="format-example">Write letters separated by commas (e.g., b, c, a)</span>
    </div>
</div>
{% endif %}

            <!-- Q5: Paragraph Writing -->
            {% if question.question_type == 'paragraph_writing' and question_number == 5 %}
            <div class="question-display">
                <h5>
                    Write a paragraph using these clue words:
                </h5>
                
                <div style="margin: 25px 0; text-align: center;">
                    <span class="clue-words-badge">time management</span>
                    <span class="clue-words-badge">planning</span>
                    <span class="clue-words-badge">daily routine</span>
                    <span class="clue-words-badge">stress</span>
                    <span class="clue-words-badge">success</span>
                </div>
                
                <div class="requirements">
                    <p class="mb-3" style="font-size: 18px; font-weight: 700; color: var(--primary-dark);">
                        <i class="fas fa-info-circle me-2"></i>
                        Write 5-6 sentences. Evaluation criteria:
                    </p>
                    <ul style="font-size: 17px; list-style-type: none; padding-left: 0;">
                        <li class="mb-2"><span style="display: inline-block; width: 30px; height: 30px; background: var(--primary-gradient); color: white; border-radius: 50%; text-align: center; line-height: 30px; margin-right: 10px;">1</span> Grammatical Accuracy (25%)</li>
                        <li class="mb-2"><span style="display: inline-block; width: 30px; height: 30px; background: var(--primary-gradient); color: white; border-radius: 50%; text-align: center; line-height: 30px; margin-right: 10px;">2</span> Vocabulary Use (25%) - Include all clue words</li>
                        <li class="mb-2"><span style="display: inline-block; width: 30px; height: 30px; background: var(--primary-gradient); color: white; border-radius: 50%; text-align: center; line-height: 30px; margin-right: 10px;">3</span> Organization & Coherence (25%) - Use transition words</li>
                        <li class="mb-2"><span style="display: inline-block; width: 30px; height: 30px; background: var(--primary-gradient); color: white; border-radius: 50%; text-align: center; line-height: 30px; margin-right: 10px;">4</span> Spelling & Punctuation (25%)</li>
                    </ul>
                </div>
            </div>
            {% endif %}
            
            <!-- Answer Box -->
            <div class="answer-box">
                <form id="answerForm">
                    {% csrf_token %}
                    <textarea id="userAnswer" 
                              class="answer-textarea" 
                              placeholder="Type your answer here..." 
                              oninput="updateWordCount()"
                              spellcheck="false"
                              autocorrect="off"
                              autocapitalize="off"
                              autocomplete="off">{{ previous_answer }}</textarea>
                    
                    <div class="word-counter">
                        <i class="fas fa-pencil-alt me-1" style="color: var(--primary);"></i>
                        <span id="wordCount">0</span> words
                    </div>
                    
                    <input type="hidden" name="question_id" value="{{ question.id }}">
                </form>
            </div>
            
            <!-- Feedback Section - This will be populated by JavaScript -->
            <div id="feedbackContainer"></div>
            
            <!-- Auto-save indicator (hidden by default) -->
            <div id="autoSaveIndicator" class="auto-save-indicator">
                <i class="fas fa-spinner fa-spin" style="color: var(--primary);"></i> Saving...
            </div>
            <div id="autoSavedIndicator" class="auto-save-indicator" style="background: rgba(16, 185, 129, 0.9);">
                <i class="fas fa-check-circle"></i> Saved
            </div>
        </div>
        
        <!-- Footer Navigation -->
        <div class="card-footer">
            <div class="d-flex justify-content-between">
                {% if prev_question %}
                <a href="{% url 'writing:writing_question' test.id prev_question %}" 
                   class="btn btn-outline-primary"
                   onclick="return autoSaveAndNavigate(this.href, 'prev')">
                    <i class="fas fa-arrow-left me-2"></i> Previous
                </a>
                {% else %}
                <div></div>
                {% endif %}
                
                <div>
                    {% if next_question %}
                    <a href="{% url 'writing:writing_question' test.id next_question %}" 
                       class="btn btn-primary"
                       onclick="return autoSaveAndNavigate(this.href, 'next')">
                        Next <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                    {% else %}
                    <button class="btn btn-warning" onclick="autoSaveAndFinish()">
                        <i class="fas fa-flag-checkered me-2"></i> Finish Test
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize word count
    function updateWordCount() {
        const textarea = document.getElementById('userAnswer');
        const text = textarea.value.trim();
        const words = text ? text.split(/\s+/).length : 0;
        document.getElementById('wordCount').textContent = words;
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateWordCount();
    });
    
    // Auto-save function - returns Promise
    function autoSave() {
        return new Promise((resolve, reject) => {
            const userAnswer = document.getElementById('userAnswer').value.trim();
            
            // If answer is empty, resolve immediately (nothing to save)
            if (!userAnswer) {
                resolve({success: true, message: 'No answer to save'});
                return;
            }
            
            // Show saving indicator
            const savingIndicator = document.getElementById('autoSaveIndicator');
            const savedIndicator = document.getElementById('autoSavedIndicator');
            
            savingIndicator.style.display = 'flex';
            savedIndicator.style.display = 'none';
            
            // Prepare form data
            const formData = new FormData();
            formData.append('user_answer', userAnswer);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Send AJAX request
            fetch('{% url "writing:save_answer" test.id question_number %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Hide saving indicator
                savingIndicator.style.display = 'none';
                
                if (data.success) {
                    // Show saved indicator briefly
                    savedIndicator.style.display = 'flex';
                    setTimeout(() => {
                        savedIndicator.style.display = 'none';
                    }, 1500);
                    
                    resolve(data);
                } else {
                    console.error('Auto-save error:', data.error);
                    reject(data.error);
                }
            })
            .catch(error => {
                savingIndicator.style.display = 'none';
                console.error('Auto-save error:', error);
                reject(error);
            });
        });
    }
    
    // Auto-save and navigate
    function autoSaveAndNavigate(url, direction) {
        // Prevent default navigation
        event.preventDefault();
        
        // Show saving message on button
        const button = event.target.closest('a, button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Saving...';
        button.disabled = true;
        
        // Perform auto-save
        autoSave()
            .then(() => {
                // Navigate to the URL
                window.location.href = url;
            })
            .catch(error => {
                // If save fails, still navigate but show error
                console.error('Auto-save failed, but continuing:', error);
                window.location.href = url;
            });
        
        return false;
    }
    
    // Auto-save and finish test
    function autoSaveAndFinish() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Saving...';
        button.disabled = true;
        
        // Perform auto-save
        autoSave()
            .then(() => {
                // Submit the finish form
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '{% url "writing:submit_writing_test" test.id %}';
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                form.appendChild(csrfInput);
                document.body.appendChild(form);
                form.submit();
            })
            .catch(error => {
                // If save fails, still submit
                console.error('Auto-save failed, but continuing:', error);
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '{% url "writing:submit_writing_test" test.id %}';
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                form.appendChild(csrfInput);
                document.body.appendChild(form);
                form.submit();
            });
    }
</script>
{% endblock %}