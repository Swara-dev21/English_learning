{% extends 'writing/base.html' %}
{% load static %}

{% block title %}Question {{ question_number }} - Writing Test{% endblock %}

{% block extra_css %}
<style>
    /* ===== PROFESSIONAL PERIWINKLE COLOR SCHEME ===== */
    :root {
        --primary: #4a62b0;
        --primary-dark: #2e4085;
        --primary-deep: #1f2d5c;
        --primary-light: #e0e7ff;
        --primary-soft: #f0f3ff;
        --gradient-primary: linear-gradient(135deg, #5f7ad4, #4a62b0, #3f58ad);
        
        --success: #10b981;
        --success-light: #d1fae5;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        
        --text-dark: #1a1f33;
        --text-medium: #2a3150;
        --text-light: #4a5578;
        --text-muted: #6b7191;
        --bg-light: #f8faff;
        --bg-white: #ffffff;
        --border-light: #e2e8f0;
        --border-medium: #cbd5e1;
        
        --shadow-sm: 0 2px 4px rgba(74, 98, 176, 0.05);
        --shadow-md: 0 8px 20px rgba(74, 98, 176, 0.1);
        --shadow-lg: 0 15px 30px rgba(74, 98, 176, 0.15);
        
        --radius: 10px;
        --radius-lg: 14px;
        --radius-xl: 20px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f0f3ff 0%, #e8eeff 100%);
        color: var(--text-dark);
        line-height: 1.5;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* ===== FIXED WIDTH STRUCTURE - 800px ===== */
    .test-wrapper {
        width: 800px;
        max-width: 800px;
        min-width: 800px;
        margin: 2rem auto;
    }

    /* ===== UNIFIED MAIN CARD ===== */
    .test-card {
        background: var(--bg-white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-light);
        overflow: hidden;
        animation: slideUp 0.6s ease;
        width: 800px;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ===== HEADER SECTION ===== */
    .test-header {
        background: var(--gradient-primary);
        color: white;
        padding: 40px 0;
        position: relative;
        overflow: hidden;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 800px;
    }

    .test-header::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .test-header h1 {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 1;
    }

    .test-header h1 i {
        color: #fef9c3;
        font-size: 2.3rem;
    }

    /* ===== CONTENT SECTION ===== */
    .test-content {
        padding: 1.5rem;
        width: 800px;
        overflow-x: hidden;
        box-sizing: border-box;
    }

    /* ===== PROGRESS SECTION ===== */
    .question-indicator {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
        text-align: left;
        width: 100%;
    }

    .progress-bar-container {
        background: #e2e8f0;
        height: 0.5rem;
        border-radius: 1rem;
        overflow: hidden;
        margin-bottom: 1.7rem;
        width: 100%;
    }

    .progress-bar-fill {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 1rem;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .progress-bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* ===== QUESTION TYPE BADGE ===== */
    .type-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--primary-light);
        color: var(--primary-dark);
        padding: 0.4rem 1rem;
        border-radius: 40px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--primary);
    }

    .type-badge i {
        font-size: 0.95rem;
    }

    /* ===== QUESTION NUMBER BADGE (Like Reading/Listening) ===== */
    .question-number-badge {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 0.3rem 1.2rem;
        border-radius: 2rem;
        margin-bottom: 1rem;
        font-size: 1rem;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(74, 98, 176, 0.2);
        letter-spacing: 0.5px;
        margin-right:0.75rem;
    }

    /* ===== QUESTION DISPLAY ===== */
    .question-display {
        background: var(--bg-light);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-light);
        width: 100%;
        box-sizing: border-box;
        overflow-x: auto;
    }

    .question-display h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .question-display h5 i {
        color: var(--primary);
        font-size: 1.1rem;
    }

    /* Fill in Blanks */
    .blank-item {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        padding: 0.85rem;
        margin-bottom: 0.6rem;
        font-size: 1rem;
        width: 100%;
        box-sizing: border-box;
        word-break: break-word;
    }

    .blank-item strong {
        color: var(--primary-dark);
        font-weight: 600;
    }

    /* Sentence Order */
    .sentence-item {
        background: white;
        border-radius: var(--radius);
        padding: 0.85rem;
        margin-bottom: 0.6rem;
        font-size: 1rem;
        border: 1px solid var(--border-light);
        width: 100%;
        box-sizing: border-box;
        word-break: break-word;
    }

    .sentence-item strong {
        color: var(--primary);
        font-weight: 600;
        margin-right: 0.5rem;
    }

    /* Hint Box */
    .hint-box {
        background: transparent !important;
        border: none !important;
        border-left: none !important;
        box-shadow: none !important;
        padding: 0.25rem;
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
        width: 100%;
        box-sizing: border-box;
    }

    .hint-box i {
        color: var(--primary);
        font-size: 1.1rem;
    }

    .format-box {
        background: white;
        border: none;
        padding: 0.25rem 0;
        margin-top: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        font-size: 0.95rem;
        color: var(--text-medium);
    }

    .format-box strong {
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .format-example {
        background: var(--primary-light);
        color: var(--primary-dark);
        padding: 0.25rem 1rem;
        border-radius: 40px;
        font-weight: 500;
        font-size: 0.9rem;
    }

    /* Clue Words */
    .clue-words-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        margin: 1.25rem 0;
        width: 100%;
    }

    .clue-word {
        background: var(--primary);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 40px;
        font-weight: 500;
        font-size: 0.95rem;
    }

    /* Requirements List - Larger text */
/* Requirements List - Slightly smaller */
.requirements-list {
    background: white;
    border: 1px solid var(--border-light);
    border-radius: var(--radius);
    padding: 1.4rem;
    margin-top: 1rem;
    width: 100%;
    box-sizing: border-box;
}

.requirements-heading {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.requirements-heading i {
    color: var(--primary);
    font-size: 1.3rem;
}

.requirements-list ul {
    list-style: none;
    padding: 0;
}

.requirements-list li {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-light);
    word-break: break-word;
    font-size: 1rem;
}

.requirements-list li:last-child {
    border-bottom: none;
}

.requirement-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    background: var(--primary-light);
    color: var(--primary);
    border-radius: 50%;
    font-size: 0.9rem;
    font-weight: 700;
    flex-shrink: 0;
}
    /* MCQ Table - Adjusted for 800px */
    .mcq-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 0.95 rem;
        table-layout: fixed;
        word-break: break-word;
    }

    .mcq-table th:first-child {
        width: 10%;
        text-align: center;
        padding: 0.6rem 0.2rem;
    }

    .mcq-table td:first-child {
        width: 10%;
        text-align: center;
        padding: 0.6rem 0.2rem;
        font-weight: 600;
    }

    .mcq-table th:not(:first-child),
    .mcq-table td:not(:first-child) {
        width: 22.5%;
        padding: 0.6rem 0.2rem;
    }

    .mcq-table th {
        background: var(--primary-light);
        color: var(--primary-dark);
        font-weight: 600;
        padding: 0.7rem 0.5rem;
        text-align: left;
        border: 1px solid var(--border-light);
    }

    .mcq-table td {
        padding: 0.7rem 0.3rem;
        border: 1px solid var(--border-light);
        word-break: break-word;
    }

    .mcq-table tr:hover {
        background: var(--bg-light);
    }

    /* Alert Box */
    .alert-box {
        background: var(--warning-light);
        border: 1px solid var(--warning);
        border-radius: var(--radius);
        padding: 1rem;
        margin: 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
        width: 100%;
        box-sizing: border-box;
        word-break: break-word;
    }

    .alert-box i {
        color: var(--warning);
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    /* Original Sentence Box */
    .original-sentence {
        width: 100%;
        box-sizing: border-box;
    }

    .original-sentence .sentence {
        word-break: break-word;
        white-space: normal;
        font-size: 1.1rem;
        font-weight: 500;
        font-style: italic;
        color: var(--text-dark);
        background: white;
        padding: 0.85rem;
        border-radius: 0.75rem;
        border: 2px dashed #f59e0b;
        width: 100%;
        box-sizing: border-box;
    }

    /* ===== ANSWER BOX ===== */
    .answer-box {
        border: 2px solid var(--border-light);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        margin: 1.25rem 0;
        background: white;
        width: 100%;
        box-sizing: border-box;
    }

    .answer-box:focus-within {
        border-color: var(--primary);
    }

    .answer-textarea {
        width: 100%;
        min-height: 70px;
        padding: 0.35rem;
        border: none;
        outline: none;
        font-size: 0.95rem;
        line-height: 1.5;
        font-family: 'Inter', sans-serif;
        resize: vertical;
        color: var(--text-dark);
        box-sizing: border-box;
    }

    .answer-textarea::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    .word-counter {
        text-align: right;
        padding-top: 0.6rem;
        margin-top: 0.6rem;
        border-top: 1px dashed var(--border-light);
        color: var(--text-muted);
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .word-counter i {
        color: var(--primary);
        font-size: 0.9rem;
    }

    .word-counter span {
        font-weight: 600;
        color: var(--text-dark);
    }

    /* ===== MESSAGE CONTAINER ===== */
    .message-container {
        margin: 1.25rem 0;
        padding: 0.85rem 1.25rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        transition: all 0.3s ease;
        width: 100%;
        box-sizing: border-box;
        font-size: 0.95rem;
    }

    .message-container.hidden {
        display: none;
    }

    .message-container.success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid #10b981;
    }

    .message-container.warning {
        background: #fef3c7;
        color: #92400e;
        border-left: 4px solid #f59e0b;
    }

    .message-container i {
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    /* ===== NAVIGATION ===== */
    .navigation-section {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin: 1.25rem 0;
        width: 100%;
    }

    .nav-btn {
        padding: 0.65rem 1.75rem;
        border-radius: 2rem;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-next {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-next:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .btn-submit {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 14px 50px;
        border-radius: 50px;
        font-weight: 500;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }

    .btn-submit:hover {
        background: linear-gradient(135deg, #059669, #047857);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    /* ===== QUESTION STATUS DOTS ===== */
    .question-status {
        display: flex;
        justify-content: center;
        gap: 0.6rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .status-dot {
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
        color: #64748b;
        transition: all 0.2s ease;
        cursor: pointer;
        flex-shrink: 0;
    }

    .status-dot.active {
        background: var(--primary);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(74, 98, 176, 0.3);
    }

    .status-dot.answered {
        background: #10b981;
        color: white;
    }

    .status-dot.answered.active {
        background: var(--primary);
    }

    .status-dot.pulse-red {
        animation: pulse-red 0.5s ease;
    }

    @keyframes pulse-red {
        0% { transform: scale(1); background: #e2e8f0; }
        50% { transform: scale(1.2); background: #ef4444; color: white; }
        100% { transform: scale(1); background: #e2e8f0; }
    }

    /* ===== AUTO-SAVE INDICATORS ===== */
    .auto-save-indicator {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        background: var(--text-dark);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 40px;
        font-size: 0.9rem;
        display: none;
        align-items: center;
        gap: 0.5rem;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        border: 1px solid rgba(255,255,255,0.1);
    }

    #autoSavedIndicator {
        background: var(--success);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .test-wrapper,
        .test-card,
        .test-header,
        .test-content {
            width: 100%;
            min-width: auto;
            max-width: 100%;
        }

        .test-header h1 {
            font-size: 1.5rem;
        }

        .navigation-section {
            justify-content: center;
        }

        .btn-submit {
            width: 100%;
        }

        .question-text {
            font-size: 1rem;
        }

        .blank-item,
        .sentence-item {
            font-size: 0.95rem;
        }

        .clue-word {
            font-size: 0.85rem;
            padding: 0.35rem 0.85rem;
        }

        .mcq-table {
            font-size: 0.75rem;
        }

        .mcq-table th,
        .mcq-table td {
            padding: 0.4rem 0.15rem;
        }
    }
    .q5-textarea {
    min-height: 200px !important;
    font-size: 1rem;
    line-height: 1.6;
}
</style>
{% endblock %}

{% block content %}
<div class="test-wrapper">
    <!-- UNIFIED MAIN CARD -->
    <div class="test-card">
        
        <!-- Header Section - Centered -->
        <div class="test-header">
            <h1>
                <i class="fas fa-pen-fancy"></i>
                Writing Test
            </h1>
        </div>
        
        <!-- Content Section -->
        <div class="test-content">
            
            <!-- Question Indicator Above Progress Bar -->
            <div class="question-indicator">
                Question {{ question_number }} of {{ total_questions }}
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar" style="width: {{ progress_percentage }}%"></div>
            </div>
            
            <!-- ===== QUESTION NUMBER BADGE (Like Reading/Listening) ===== -->
            <div class="question-number-badge">
                Q{{ question_number }}
            </div>

            <!-- Question Type Badge -->
            <div class="type-badge">
                <i class="fas fa-tag"></i>
                {{ question.get_question_type_display }}
            </div>


            <!-- ===== HARDCODED QUESTIONS BY TYPE ===== -->

            <!-- Q1: Fill in the Blanks -->
            {% if question.question_type == 'fill_blanks' and question_number == 1 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-puzzle-piece"></i>
                    Complete these sentences:
                </h5>
                
                <div class="blank-item">
                    1. She <strong>___ (go/goes)</strong> to college every day.
                </div>
                <div class="blank-item">
                    2. The students <strong>___ (is/are)</strong> in the classroom.
                </div>
                <div class="blank-item">
                    3. This is <strong>___ (a / an)</strong> useful book.
                </div>
                
                <div class="format-box">
                    <strong><i class="fas fa-info-circle"></i>FORMAT:</strong>
                    <span class="format-example">Write answers separated by commas (e.g., am,is,are)</span>
                </div>
            </div>
            {% endif %}

            <!-- Q2: Sentence Order -->
            {% if question.question_type == 'sentence_order' and question_number == 2 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-sort-amount-down"></i>
                    Arrange these sentences in logical order:
                </h5>
                
                <div class="sentence-item">
                    <strong>A.</strong> We submitted the assignment.
                </div>
                <div class="sentence-item">
                    <strong>B.</strong> The teacher explained the topic.
                </div>
                <div class="sentence-item">
                    <strong>C.</strong> The class started at ten.
                </div>
                
                <div class="hint-box">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Hint:</strong> Think about what happens first, second, and last.
                </div>
                
                <div class="format-box">
                    <strong><i class="fas fa-info-circle"></i>FORMAT:</strong>
                    <span class="format-example">Write letters in order (e.g., A, B, C)</span>
                </div>
            </div>
            {% endif %}

            <!-- Q3: Sentence Rewrite -->
            {% if question.question_type == 'sentence_rewrite' and question_number == 3 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-spell-check"></i>
                    Rewrite the sentence correctly:
                </h5>
                
                <div style="background: var(--bg-light); padding: 0.85rem; border-radius: var(--radius); margin-bottom: 1rem;">
                    <div style="font-weight: 700; color: var(--text-medium); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Original Sentence:
                    </div>
                    <div style="font-size: 1rem; font-weight: 500; font-style: italic; color: var(--text-dark);">
                        "comunication skills are important however students often ignore punctution grammer and clarity"
                    </div>
                </div>
                
                <div class="format-box">
                    <i class="fas fa-check-circle"></i>
                    <strong>Check for:</strong>  <span class="format-example">Spelling, punctuation, capitalization, and grammar</span>
                </div>
            </div>
            {% endif %}

            <!-- Q4: Spelling MCQ -->
            {% if question.question_type == 'spelling_mcq' and question_number == 4 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-check-double"></i>
                    Choose the correctly spelled word:
                </h5>
                
                <table class="mcq-table">
                    <tr>
                        <th>Q1</th>
                        <td>a) recieve</td>
                        <td>b) receive</td>
                        <td>c) recite</td>
                        <td>d) receieve</td>
                    </tr>
                    <tr>
                        <th>Q2</th>
                        <td>a) definately</td>
                        <td>b) definitely</td>
                        <td>c) diffidently</td>
                        <td>d) defenetly</td>
                    </tr>
                    <tr>
                        <th>Q3</th>
                        <td>a) seperate</td>
                        <td>b) separate</td>
                        <td>c) sepereta</td>
                        <td>d) seprate</td>
                    </tr>
                </table>
                
                <div class="format-box">
                    <strong><i class="fas fa-info-circle"></i>FORMAT:</strong>
                    <span class="format-example">Write letters separated by commas (e.g., b, b, b)</span>
                </div>
            </div>
            {% endif %}

            <!-- Q5: Paragraph Writing -->
            {% if question.question_type == 'paragraph_writing' and question_number == 5 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-paragraph"></i>
                    Write a paragraph using these clue words:
                </h5>
                
                <div class="clue-words-container">
                    <span class="clue-word">time management</span>
                    <span class="clue-word">planning</span>
                    <span class="clue-word">daily routine</span>
                    <span class="clue-word">stress</span>
                    <span class="clue-word">success</span>
                </div>
                
                <div class="requirements-list">
                    <p>
                                 <i class="fas fa-pencil-alt"></i>  <!-- Changed to pencil icon -->
            <span style="font-size: 1.1rem; font-weight: 700;">Write 5-6 sentences. Evaluation criteria:</span>
                    </p>
                    <ul>
                        <li>
                            <span class="requirement-number">1</span>
                            Grammatical Accuracy (25%)
                        </li>
                        <li>
                            <span class="requirement-number">2</span>
                            Vocabulary Use (25%) - Include all clue words
                        </li>
                        <li>
                            <span class="requirement-number">3</span>
                            Organization & Coherence (25%)
                        </li>
                        <li>
                            <span class="requirement-number">4</span>
                            Spelling & Punctuation (25%)
                        </li>
                    </ul>
                </div>
            </div>
            {% endif %}
            
            <!-- Answer Box -->
    
            <div class="answer-box">
                <form id="answerForm" method="POST" action="{% url 'writing:submit_writing_test' test.id %}">
                    {% csrf_token %}
                    <textarea id="userAnswer" 
                            class="answer-textarea {% if question_number == 5 %}q5-textarea{% endif %}" 
                            placeholder="Type your answer here..." 
                            oninput="updateWordCount()"
                            spellcheck="false"
                            autocorrect="off"
                            autocapitalize="off"
                            autocomplete="off">{{ previous_answer }}</textarea>
                    
                    <div class="word-counter">
                        <i class="fas fa-pencil-alt"></i>
                        <span id="wordCount">0</span> words
                    </div>
                    
                    <input type="hidden" name="question_id" value="{{ question.id }}">
                </form>
            </div>
            <!-- Message Container -->
            <div id="messageContainer" class="message-container hidden">
                <i class="fas"></i>
                <span></span>
            </div>
            
            <!-- Navigation Section - Only Next Button or Centered Submit -->
            <div class="navigation-section" style="justify-content: {% if next_question %}flex-end{% else %}center{% endif %};">
                {% if next_question %}
                <button type="button" class="nav-btn btn-next" onclick="handleNextClick()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                {% else %}
                <button type="button" class="nav-btn btn-submit" onclick="handleSubmitClick()">
                    <i class="fas fa-paper-plane"></i> Submit Test
                </button>
                {% endif %}
            </div>
            
            <!-- Question Status Dots -->
            <div class="question-status">
                {% for i in "12345"|make_list %}
                <div class="status-dot" id="dot-{{ forloop.counter }}" data-dot="{{ forloop.counter }}" onclick="jumpToQuestion({{ forloop.counter }})">
                    {{ forloop.counter }}
                </div>
                {% endfor %}
            </div>
            
        </div> <!-- End test-content -->
    </div> <!-- End test-card -->
</div> <!-- End test-wrapper -->

<!-- Auto-save indicators -->
<div id="autoSaveIndicator" class="auto-save-indicator">
    <i class="fas fa-spinner fa-spin"></i> Saving...
</div>
<div id="autoSavedIndicator" class="auto-save-indicator">
    <i class="fas fa-check-circle"></i> Saved
</div>

<script>
    // Variables
    const totalQuestions = 5;
    let currentQuestion = {{ question_number }};
    
    // Initialize answered array with ALL answered questions from server
    let answered = new Array(totalQuestions + 1).fill(false);
    
    // Get elements
    const progressBar = document.getElementById('progressBar');
    const messageContainer = document.getElementById('messageContainer');
    
    // Initialize word count
    function updateWordCount() {
        const textarea = document.getElementById('userAnswer');
        const text = textarea.value.trim();
        const words = text ? text.split(/\s+/).length : 0;
        document.getElementById('wordCount').textContent = words;
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateWordCount();
        updateProgressBar();
        
        // Get all answered questions from the server
        const answeredQuestions = {{ answered_questions|safe }};  // Pass this from Django view
        
        // Mark all answered questions
        if (answeredQuestions && Array.isArray(answeredQuestions)) {
            answeredQuestions.forEach(qNum => {
                if (qNum >= 1 && qNum <= totalQuestions) {
                    answered[qNum] = true;
                }
            });
        }
        
        // Check if current question has answer in textarea (for unsaved changes)
        const textarea = document.getElementById('userAnswer');
        if (textarea && textarea.value.trim()) {
            answered[currentQuestion] = true;
        }
        
        // Update dots with all answered information
        updateDots();
    });
    
    // Show message function
    function showMessage(type, text) {
        messageContainer.classList.remove('hidden', 'success', 'warning');
        
        const icon = messageContainer.querySelector('i');
        const span = messageContainer.querySelector('span');
        
        if (type === 'success') {
            messageContainer.classList.add('success');
            icon.className = 'fas fa-check-circle';
            span.textContent = text || ' Answer saved!';
        } else if (type === 'warning') {
            messageContainer.classList.add('warning');
            icon.className = 'fas fa-exclamation-triangle';
            span.textContent = text || ' Please answer this question first';
        }
        
        setTimeout(() => {
            messageContainer.classList.add('hidden');
        }, 3000);
    }
    
    // Pulse red function
    function pulseRed(questionNum) {
        const dot = document.getElementById(`dot-${questionNum}`);
        if (dot) {
            dot.classList.add('pulse-red');
            setTimeout(() => {
                dot.classList.remove('pulse-red');
            }, 500);
        }
    }
    
    // Update dots function
    function updateDots() {
        for (let i = 1; i <= totalQuestions; i++) {
            const dot = document.getElementById(`dot-${i}`);
            if (!dot) continue;
            
            dot.classList.remove('active', 'answered');
            
            if (i === currentQuestion) {
                dot.classList.add('active');
            } else if (answered[i]) {
                dot.classList.add('answered');
            }
            // Else keep default gray (no class needed)
        }
    }
    
    // Update progress bar
    function updateProgressBar() {
        const progress = (currentQuestion / totalQuestions) * 100;
        progressBar.style.width = progress + '%';
    }
    
    // Jump to question
    window.jumpToQuestion = function(num) {
        window.location.href = '{% url "writing:writing_question" test.id 0 %}'.replace('0', num);
    };
    
    // Handle Next button click
    window.handleNextClick = function() {
        const userAnswer = document.getElementById('userAnswer').value.trim();
        
        if (!userAnswer && !answered[currentQuestion]) {
            showMessage('warning', ' Please answer this question first');
            pulseRed(currentQuestion);
            return;
        }
        
        // Save the answer then navigate
        autoSave().then(() => {
            const nextUrl = '{% url "writing:writing_question" test.id 0 %}'.replace('0', currentQuestion + 1);
            window.location.href = nextUrl;
        }).catch(() => {
            const nextUrl = '{% url "writing:writing_question" test.id 0 %}'.replace('0', currentQuestion + 1);
            window.location.href = nextUrl;
        });
    };
    
    // Handle Submit button click
    window.handleSubmitClick = function() {
        const userAnswer = document.getElementById('userAnswer').value.trim();
        
        // Check if there's an answer in the textarea OR if it's already marked as answered
        if (!userAnswer && !answered[currentQuestion]) {
            showMessage('warning', ' Please answer this question before submitting');
            pulseRed(currentQuestion);
            return;
        }
        
        // Auto-save then submit the form
        autoSave().then(() => {
            document.getElementById('answerForm').submit();
        }).catch(() => {
            document.getElementById('answerForm').submit();
        });
    };
    
    // Auto-save function (without popups)
    function autoSave() {
        return new Promise((resolve, reject) => {
            const userAnswer = document.getElementById('userAnswer').value.trim();
            
            if (!userAnswer) {
                resolve({success: true, message: 'No answer to save'});
                return;
            }
            
            const formData = new FormData();
            formData.append('user_answer', userAnswer);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('{% url "writing:save_answer" test.id question_number %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    answered[currentQuestion] = true;
                    updateDots();
                    showMessage('success', ' Answer saved!');
                    resolve(data);
                } else {
                    reject(data.error);
                }
            })
            .catch(error => {
                reject(error);
            });
        });
    }
</script>
{% endblock %}