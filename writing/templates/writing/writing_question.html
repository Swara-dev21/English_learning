{% extends 'writing/base.html' %}
{% load static %}

{% block title %}Question {{ question_number }} - Writing Test{% endblock %}

{% block extra_css %}
<style>
    /* ===== PROFESSIONAL PERIWINKLE COLOR SCHEME ===== */
    :root {
        --primary: #4a62b0;
        --primary-dark: #2e4085;
        --primary-deep: #1f2d5c;
        --primary-light: #e0e7ff;
        --primary-soft: #f0f3ff;
        --gradient-primary: linear-gradient(135deg, #5f7ad4, #4a62b0, #3f58ad);
        
        --success: #10b981;
        --success-light: #d1fae5;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        
        --text-dark: #1a1f33;
        --text-medium: #2a3150;
        --text-light: #4a5578;
        --text-muted: #6b7191;
        --bg-light: #f8faff;
        --bg-white: #ffffff;
        --border-light: #e2e8f0;
        --border-medium: #cbd5e1;
        
        --shadow-sm: 0 2px 4px rgba(74, 98, 176, 0.05);
        --shadow-md: 0 8px 20px rgba(74, 98, 176, 0.1);
        --shadow-lg: 0 15px 30px rgba(74, 98, 176, 0.15);
        
        --radius: 10px;
        --radius-lg: 14px;
        --radius-xl: 20px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f0f3ff 0%, #e8eeff 100%);
        color: var(--text-dark);
        line-height: 1.5;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }
            /* Back buttons container - outside the box */
        .back-buttons-container {
            position: absolute;
            top: 30px;
            left: 30px;
            right: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            width: calc(100% - 60px);
        }

        .back-link-top, .home-link-top {
            color: #4a5568;
            text-decoration: none;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            padding: 10px 15px;
            background-color: white;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .back-link-top:hover, .home-link-top:hover {
            color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .back-link-top i, .home-link-top i {
            font-size: 14px;
        }

        .reset-wrapper {
            max-width: 480px;
            width: 100%;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reset-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(74, 98, 176, 0.15);
            overflow: hidden;
            width: 100%;
        }


    /* ===== FIXED WIDTH STRUCTURE - 800px ===== */
    .test-wrapper {
        width: 800px;
        max-width: 800px;
        min-width: 800px;
        margin: 2rem auto;
    }

    /* ===== UNIFIED MAIN CARD ===== */
    .test-card {
        background: var(--bg-white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-light);
        overflow: hidden;
        animation: slideUp 0.6s ease;
        width: 800px;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ===== HEADER SECTION ===== */
    .test-header {
        background: var(--gradient-primary);
        color: white;
        padding: 40px 0;
        position: relative;
        overflow: hidden;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 800px;
    }

    .test-header::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .test-header h1 {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 1;
    }

    .test-header h1 i {
        color: #fef9c3;
        font-size: 2.3rem;
    }

    /* ===== CONTENT SECTION ===== */
    .test-content {
        padding: 1.5rem;
        width: 800px;
        overflow-x: hidden;
        box-sizing: border-box;
    }

    /* ===== PROGRESS SECTION ===== */
    .question-indicator {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
        text-align: left;
        width: 100%;
    }

    .progress-bar-container {
        background: #e2e8f0;
        height: 0.5rem;
        border-radius: 1rem;
        overflow: hidden;
        margin-bottom: 1.7rem;
        width: 100%;
    }

    .progress-bar-fill {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 1rem;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .progress-bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* ===== QUESTION NUMBER BADGE ===== */
    .question-number-badge {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 0.3rem 1.2rem;
        border-radius: 2rem;
        margin-bottom: 1rem;
        font-size: 1rem;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(74, 98, 176, 0.2);
        letter-spacing: 0.5px;
        margin-right:0.75rem;
    }

    /* ===== QUESTION TYPE BADGE ===== */
    .type-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--primary-light);
        color: var(--primary-dark);
        padding: 0.4rem 1rem;
        border-radius: 40px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--primary);
    }

    .type-badge i {
        font-size: 0.95rem;
    }

    /* ===== QUESTION DISPLAY ===== */
    .question-display {
        background: var(--bg-light);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-light);
        width: 100%;
        box-sizing: border-box;
        overflow-x: auto;
    }

    .question-display h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .question-display h5 i {
        color: var(--primary);
        font-size: 1.1rem;
    }

    /* ===== Q1: FILL IN THE BLANKS - IMPROVED LAYOUT ===== */
    .fill-blanks-container {
        width: 100%;
    }

    .blank-sentence {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        margin-bottom: 0.8rem;
        flex-wrap: wrap;
    }

    .sentence-number {
        font-weight: 700;
        color: var(--primary-dark);
        min-width: 24px;
        font-size: 1rem;
    }

    .sentence-prefix {
        color: var(--text-dark);
        font-size: 1rem;
    }

    .blank-space {
        display: inline-block;
        min-width: 50px;
        padding: 0.3rem 0.8rem;
        background: var(--primary-light);
        border: 2px dashed var(--primary);
        border-radius: 20px;
        text-align: center;
        font-weight: 600;
        color: var(--primary-dark);
        transition: all 0.2s ease;
    }

    .blank-space.filled {
        background: var(--success-light);
        border-color: var(--success);
        color: var(--success-dark);
        border-style: solid;
    }

    .sentence-suffix {
        color: var(--text-dark);
        font-size: 1rem;
        margin-left: 0.2rem;
    }

    .options-row {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
        flex-shrink: 0;
    }

    .option-btn {
        background: white;
        border: 2px solid var(--primary-light);
        color: var(--primary);
        padding: 0.3rem 1rem;
        border-radius: 30px;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .option-btn:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .option-btn.selected {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
        box-shadow: var(--shadow-md);
    }

    .selected-answers-display {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: var(--primary-soft);
        border-radius: var(--radius);
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-left: 4px solid var(--primary);
    }

    .selected-answers-display strong {
        color: var(--primary-dark);
    }

    .selected-answers-display span {
        color: var(--text-dark);
        font-weight: 500;
    }

    /* ===== Q2: INSTRUCTION BOX ===== */
    .instruction-box {
        background: var(--primary-soft);
        border: 1px solid var(--primary);
        border-radius: var(--radius);
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
        color: var(--text-dark);
        border-left: 4px solid var(--primary);
    }

    .instruction-box i {
        color: var(--primary);
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .instruction-box strong {
        color: var(--primary-dark);
    }

    /* ===== Q2: SENTENCE ORDER ===== */
    .sentence-order-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin: 1rem 0;
        min-height: 200px;
    }
    
    .sentence-card {
        background: white;
        border: 2px solid var(--primary-light);
        border-radius: var(--radius-lg);
        padding: 0.7rem 1.2rem;
        font-size: 1.1rem;
        cursor: grab;
        transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        display: flex;
        align-items: center;
        gap: 0.8rem;
        box-shadow: var(--shadow-sm);
        position: relative;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        transform-origin: center;
        width: 100%;
        margin: 0;
    }
    
    .sentence-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px) scale(1.01);
        box-shadow: var(--shadow-md);
        background: linear-gradient(to right, white, var(--primary-soft));
    }
    
    .sentence-card:active {
        cursor: grabbing;
        transform: scale(1.02);
        box-shadow: var(--shadow-lg);
    }
    
    .sentence-card.dragging {
        opacity: 0.7;
        transform: scale(1.03) rotate(1deg);
        box-shadow: var(--shadow-lg);
        cursor: grabbing;
        background: linear-gradient(135deg, white, var(--primary-soft));
        border-color: var(--primary);
        z-index: 1000;
    }
    
    .sentence-letter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: var(--gradient-primary);
        color: white;
        border-radius: 50%;
        font-weight: 700;
        font-size: 1.1rem;
        flex-shrink: 0;
        box-shadow: 0 4px 8px rgba(74, 98, 176, 0.3);
        transition: all 0.2s ease;
    }
    
    .sentence-text {
        flex: 1;
        color: var(--text-dark);
        font-weight: 500;
        line-height: 1.4;
    }
    
    .drag-handle {
        color: var(--primary);
        font-size: 1rem;
        opacity: 0.4;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.1rem;
        padding: 0.2rem 0.4rem;
        border-radius: 20px;
        background: var(--primary-light);
        cursor: grab;
        flex-shrink: 0;
    }
    
    .sentence-card:hover .drag-handle {
        opacity: 1;
        background: var(--primary);
        color: white;
        transform: scale(1.05);
    }
    
    .drag-handle i {
        font-size: 0.8rem;
    }

    .current-order-display {
        background: var(--primary-soft);
        border-radius: var(--radius);
        padding: 0.6rem 1rem;
        margin: 0.8rem 0 0;
        border-left: 4px solid var(--primary);
        display: inline-block;
    }

    .current-order-label {
        font-weight: 600;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .current-order-label i {
        font-size: 0.9rem;
    }

    .current-order-value {
        font-weight: 700;
        color: var(--text-dark);
        background: white;
        padding: 0.2rem 0.8rem;
        border-radius: 40px;
        border: 1px solid var(--primary-light);
        letter-spacing: 1px;
        font-size: 1rem;
        margin-left: 0.5rem;
    }

    /* ===== Q3: SENTENCE REWRITE ===== */
    .format-box {
        background: var(--primary-soft);
        border-radius: var(--radius);
        padding: 0.75rem 1rem;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        font-size: 0.95rem;
        border-left: 4px solid var(--primary);
    }

    .format-box i {
        color: var(--primary);
        font-size: 1rem;
    }

    .format-box strong {
        color: var(--primary-dark);
    }

    .format-example {
        background: var(--primary-light);
        color: var(--primary-dark);
        padding: 0.2rem 1rem;
        border-radius: 40px;
        font-weight: 500;
    }

    /* ===== Q4: RADIO BUTTONS ===== */
    .mcq-radio-container {
        margin: 0.5rem 0 1rem;
        width: 100%;
    }
    
    .mcq-question-item {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
    }
    
    .mcq-question-header {
        margin-bottom: 0.8rem;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 1rem;
    }
    
    .mcq-options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem;
    }
    
    .mcq-radio-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 0.8rem;
        background: var(--bg-light);
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .mcq-radio-option:hover {
        background: var(--primary-light);
        border-color: var(--primary);
        transform: translateY(-2px);
    }
    
    .mcq-radio-option.selected {
        background: var(--primary-light);
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(74, 98, 176, 0.2);
    }
    
    .mcq-radio-option input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
        cursor: pointer;
    }
    
    .mcq-radio-option .option-letter {
        font-weight: 700;
        color: var(--primary);
        min-width: 22px;
        font-size: 1rem;
    }
    
    .mcq-radio-option .option-text {
        color: var(--text-dark);
        font-size: 0.95rem;
    }

    /* ===== Q5: PARAGRAPH WRITING ===== */
    .clue-words-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        margin: 1.25rem 0;
        width: 100%;
    }

    .clue-word {
        background: var(--primary);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 40px;
        font-weight: 500;
        font-size: 0.95rem;
    }

    .requirements-list {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        padding: 1.4rem;
        margin-top: 1rem;
        width: 100%;
        box-sizing: border-box;
    }

    .requirements-list p {
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .requirements-list ul {
        list-style: none;
        padding: 0;
    }

    .requirements-list li {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-light);
        word-break: break-word;
        font-size: 1rem;
    }

    .requirements-list li:last-child {
        border-bottom: none;
    }

    .requirement-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px;
        height: 26px;
        background: var(--primary-light);
        color: var(--primary);
        border-radius: 50%;
        font-size: 0.9rem;
        font-weight: 700;
        flex-shrink: 0;
    }

    .q5-textarea {
        min-height: 200px !important;
        font-size: 1rem;
        line-height: 1.6;
    }

    /* ===== ANSWER BOX ===== */
    .answer-box {
        border: 2px solid var(--border-light);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        margin: 1.25rem 0;
        background: white;
        width: 100%;
        box-sizing: border-box;
    }

    .answer-box:focus-within {
        border-color: var(--primary);
    }

    .answer-textarea {
        width: 100%;
        min-height: 70px;
        padding: 0.35rem;
        border: none;
        outline: none;
        font-size: 0.95rem;
        line-height: 1.5;
        font-family: 'Inter', sans-serif;
        resize: vertical;
        color: var(--text-dark);
        box-sizing: border-box;
    }

    .answer-textarea::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    .word-counter {
        text-align: right;
        padding-top: 0.6rem;
        margin-top: 0.6rem;
        border-top: 1px dashed var(--border-light);
        color: var(--text-muted);
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .word-counter i {
        color: var(--primary);
        font-size: 0.9rem;
    }

    .word-counter span {
        font-weight: 600;
        color: var(--text-dark);
    }

    /* ===== MESSAGE CONTAINER ===== */
    .message-container {
        margin: 1.25rem 0;
        padding: 0.85rem 1.25rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        transition: all 0.3s ease;
        width: 100%;
        box-sizing: border-box;
        font-size: 0.95rem;
    }

    .message-container.hidden {
        display: none;
    }

    .message-container.success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid #10b981;
    }

    .message-container.warning {
        background: #fef3c7;
        color: #92400e;
        border-left: 4px solid #f59e0b;
    }

    .message-container i {
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    /* ===== NAVIGATION ===== */
    .navigation-section {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin: 1.25rem 0;
        width: 100%;
    }

    .nav-btn {
        padding: 0.65rem 1.75rem;
        border-radius: 2rem;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-next {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .btn-next:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .btn-submit {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 14px 50px;
        border-radius: 50px;
        font-weight: 500;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }

    .btn-submit:hover {
        background: linear-gradient(135deg, #059669, #047857);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    /* ===== QUESTION STATUS DOTS ===== */
    .question-status {
        display: flex;
        justify-content: center;
        gap: 0.6rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .status-dot {
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
        color: #64748b;
        transition: all 0.2s ease;
        cursor: pointer;
        flex-shrink: 0;
    }

    .status-dot.active {
        background: var(--primary);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(74, 98, 176, 0.3);
    }

    .status-dot.answered {
        background: #10b981;
        color: white;
    }

    .status-dot.answered.active {
        background: var(--primary);
    }

    .status-dot.pulse-red {
        animation: pulse-red 0.5s ease;
    }

    @keyframes pulse-red {
        0% { transform: scale(1); background: #e2e8f0; }
        50% { transform: scale(1.2); background: #ef4444; color: white; }
        100% { transform: scale(1); background: #e2e8f0; }
    }

    /* ===== AUTO-SAVE INDICATORS ===== */
    .auto-save-indicator {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        background: var(--text-dark);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 40px;
        font-size: 0.9rem;
        display: none;
        align-items: center;
        gap: 0.5rem;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        border: 1px solid rgba(255,255,255,0.1);
    }

    #autoSavedIndicator {
        background: var(--success);
    }

    .hidden-answer-field {
        display: none;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 640px) {
        .blank-sentence {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .options-row {
            margin-left: 0;
            width: 100%;
            justify-content: flex-start;
        }
        
        .sentence-card {
            width: 100%;
        }
        
        .mcq-options-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="back-buttons-container">
        <a href="{% url 'home_page:home' %}" class="home-link-top">
           <i class="fas fa-arrow-left"></i> Back to Home 
        </a>
        <a href="{% url 'home_page:profile' %}" class="home-link-top">
            Profile <i class="fas fa-arrow-right"></i>
        </a>
    </div>

<div class="test-wrapper">
    <!-- UNIFIED MAIN CARD -->
    <div class="test-card">
        
        <!-- Header Section - Centered -->
        <div class="test-header">
            <h1>
                <i class="fas fa-pen-fancy"></i>
                Writing Test
            </h1>
        </div>
        
        <!-- Content Section -->
        <div class="test-content">
            
            <!-- Question Indicator Above Progress Bar -->
            <div class="question-indicator">
                Question {{ question_number }} of {{ total_questions }}
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar" style="width: {{ progress_percentage }}%"></div>
            </div>
            
            <!-- ===== QUESTION NUMBER BADGE ===== -->
            <div class="question-number-badge">
                Q{{ question_number }}
            </div>

            <!-- Question Type Badge -->
            <div class="type-badge">
                <i class="fas fa-tag"></i>
                {{ question.get_question_type_display }}
            </div>

            <!-- ===== HARDCODED QUESTIONS BY TYPE ===== -->

            <!-- Q1: Fill in the Blanks - IMPROVED LAYOUT -->
            {% if question.question_type == 'fill_blanks' and question_number == 1 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-puzzle-piece"></i>
                    Complete these sentences by clicking the correct options:
                </h5>
                
                <div class="fill-blanks-container">
                    <!-- Sentence 1 -->
                    <div class="blank-sentence">
                        <span class="sentence-number">1.</span>
                        <span class="sentence-prefix">She</span>
                        <span class="blank-space" id="blank1">___</span>
                        <span class="sentence-suffix">to college every day.</span>
                        <div class="options-row" data-blank="1">
                            <button type="button" class="option-btn" data-value="go" data-blank="1">go</button>
                            <button type="button" class="option-btn" data-value="goes" data-blank="1">goes</button>
                        </div>
                    </div>

                    <!-- Sentence 2 -->
                    <div class="blank-sentence">
                        <span class="sentence-number">2.</span>
                        <span class="sentence-prefix">The students</span>
                        <span class="blank-space" id="blank2">___</span>
                        <span class="sentence-suffix">in the classroom.</span>
                        <div class="options-row" data-blank="2">
                            <button type="button" class="option-btn" data-value="is" data-blank="2">is</button>
                            <button type="button" class="option-btn" data-value="are" data-blank="2">are</button>
                        </div>
                    </div>

                    <!-- Sentence 3 -->
                    <div class="blank-sentence">
                        <span class="sentence-number">3.</span>
                        <span class="sentence-prefix">This is</span>
                        <span class="blank-space" id="blank3">___</span>
                        <span class="sentence-suffix">useful book.</span>
                        <div class="options-row" data-blank="3">
                            <button type="button" class="option-btn" data-value="a" data-blank="3">a</button>
                            <button type="button" class="option-btn" data-value="an" data-blank="3">an</button>
                        </div>
                    </div>
                </div>

                <!-- Display selected answers -->
                <div class="selected-answers-display" id="selectedAnswers">
                    <strong>Your answers:</strong> <span id="answersPreview">Not selected yet</span>
                </div>
            </div>
            {% endif %}

            <!-- Q2: Sentence Order - WITH INSTRUCTION BOX -->
            {% if question.question_type == 'sentence_order' and question_number == 2 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-sort-amount-down"></i>
                    Arrange these sentences in logical order:
                </h5>
                
                <!-- Instruction Box for Drag and Drop -->
                <div class="instruction-box">
                    <span><strong>How to arrange:</strong> Click and drag the sentence boxes to reorder them. Release to drop in the new position.</span>
                </div>
                
                <!-- Drag and Drop Container -->
                <div class="sentence-order-container" id="sentenceOrderContainer">
                    <!-- Sentences will be populated by JavaScript -->
                </div>
                
                <!-- Current order display -->
                <div class="current-order-display">
                    <span class="current-order-label">
                        <i class="fas fa-arrow-right"></i> Your order:
                        <span class="current-order-value" id="currentOrderValue">A, B, C</span>
                    </span>
                </div>
                
                <!-- Hidden input to store the order -->
                <input type="hidden" id="sentenceOrderAnswer" name="sentence_order_answer" value="">
            </div>
            {% endif %}

            <!-- Q3: Sentence Rewrite -->
            {% if question.question_type == 'sentence_rewrite' and question_number == 3 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-spell-check"></i>
                    Rewrite the sentence correctly:
                </h5>
                
                <div style="background: var(--bg-light); padding: 0.85rem; border-radius: var(--radius); margin-bottom: 1rem;">
                    <div style="font-weight: 700; color: var(--text-medium); margin-bottom: 0.5rem; font-size: 0.95rem;">
                        Original Sentence:
                    </div>
                    <div style="font-size: 1rem; font-weight: 500; font-style: italic; color: var(--text-dark);">
                        "comunication skills are important however students often ignore punctution grammer and clarity"
                    </div>
                </div>
                
                <div class="format-box">
                    <i class="fas fa-check-circle"></i>
                    <strong>Check for:</strong>  <span class="format-example">Spelling, punctuation, capitalization, and grammar</span>
                </div>
            </div>
            {% endif %}

            <!-- Q4: Spelling MCQ -->
            {% if question.question_type == 'spelling_mcq' and question_number == 4 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-check-double"></i>
                    Choose the correctly spelled word:
                </h5>
                
                <div class="mcq-radio-container" id="mcqRadioContainer">
                    <!-- Question 1 -->
                    <div class="mcq-question-item">
                        <div class="mcq-question-header">1.</div>
                        <div class="mcq-options-grid" id="q1-options">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Question 2 -->
                    <div class="mcq-question-item">
                        <div class="mcq-question-header">2.</div>
                        <div class="mcq-options-grid" id="q2-options">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Question 3 -->
                    <div class="mcq-question-item">
                        <div class="mcq-question-header">3.</div>
                        <div class="mcq-options-grid" id="q3-options">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Hidden input to store answers -->
                <input type="hidden" id="mcqAnswers" name="user_answer" value="{{ previous_answer }}">
            </div>
            {% endif %}

            <!-- Q5: Paragraph Writing -->
            {% if question.question_type == 'paragraph_writing' and question_number == 5 %}
            <div class="question-display">
                <h5>
                    <i class="fas fa-paragraph"></i>
                    Write a paragraph using these clue words:
                </h5>
                
                <div class="clue-words-container">
                    <span class="clue-word">time management</span>
                    <span class="clue-word">planning</span>
                    <span class="clue-word">daily routine</span>
                    <span class="clue-word">stress</span>
                    <span class="clue-word">success</span>
                </div>
                
                <div class="requirements-list">
                    <p>
                        <i class="fas fa-pencil-alt"></i>  
                        <span style="font-weight: 700;">Write 5-6 sentences. Evaluation criteria:</span>
                    </p>
                    <ul>
                        <li>
                            <span class="requirement-number">1</span>
                            Grammatical Accuracy (25%)
                        </li>
                        <li>
                            <span class="requirement-number">2</span>
                            Vocabulary Use (25%) - Include all clue words
                        </li>
                        <li>
                            <span class="requirement-number">3</span>
                            Organization & Coherence (25%)
                        </li>
                        <li>
                            <span class="requirement-number">4</span>
                            Spelling & Punctuation (25%)
                        </li>
                    </ul>
                </div>
            </div>
            {% endif %}
            
            <!-- Answer Box -->
            <div class="answer-box">
                <form id="answerForm" method="POST" action="{% url 'writing:submit_writing_test' test.id %}">
                    {% csrf_token %}
                    
                    {% if question.question_type == 'fill_blanks' and question_number == 1 %}
                        <!-- Hidden input for Q1 -->
                        <input type="hidden" id="fillBlanksAnswer" name="user_answer" value="{{ previous_answer }}">
                    {% elif question.question_type == 'sentence_order' and question_number == 2 %}
                        <!-- Hidden input for Q2 is already in the question display -->
                        <input type="hidden" id="sentenceOrderAnswer" name="user_answer" value="{{ previous_answer }}">
                    {% elif question.question_type == 'spelling_mcq' and question_number == 4 %}
                        <!-- Hidden input for Q4 is already in the question display -->
                    {% else %}
                        <!-- Regular textarea for other questions -->
                        <textarea id="userAnswer" 
                                class="answer-textarea {% if question_number == 5 %}q5-textarea{% endif %}" 
                                placeholder="Type your answer here..." 
                                oninput="updateWordCount()"
                                spellcheck="false"
                                autocorrect="off"
                                autocapitalize="off"
                                autocomplete="off">{{ previous_answer }}</textarea>
                        
                        <div class="word-counter">
                            <i class="fas fa-pencil-alt"></i>
                            <span id="wordCount">0</span> words
                        </div>
                    {% endif %}
                    
                    <input type="hidden" name="question_id" value="{{ question.id }}">
                </form>
            </div>

            <!-- Message Container -->
            <div id="messageContainer" class="message-container hidden">
                <i class="fas"></i>
                <span></span>
            </div>
            
            <!-- Navigation Section -->
            <div class="navigation-section" style="justify-content: {% if next_question %}flex-end{% else %}center{% endif %};">
                {% if next_question %}
                <button type="button" class="nav-btn btn-next" onclick="handleNextClick()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                {% else %}
                <button type="button" class="nav-btn btn-submit" onclick="handleSubmitClick()">
                    <i class="fas fa-paper-plane"></i> Submit Test
                </button>
                {% endif %}
            </div>
            
            <!-- Question Status Dots -->
            <div class="question-status">
                {% for i in "12345"|make_list %}
                <div class="status-dot" id="dot-{{ forloop.counter }}" data-dot="{{ forloop.counter }}" onclick="jumpToQuestion({{ forloop.counter }})">
                    {{ forloop.counter }}
                </div>
                {% endfor %}
            </div>
            
        </div> <!-- End test-content -->
    </div> <!-- End test-card -->
</div> <!-- End test-wrapper -->

<!-- Auto-save indicators -->
<div id="autoSaveIndicator" class="auto-save-indicator">
    <i class="fas fa-spinner fa-spin"></i> Saving...
</div>
<div id="autoSavedIndicator" class="auto-save-indicator">
    <i class="fas fa-check-circle"></i> Saved
</div>

<script>
    // Variables
    const totalQuestions = 5;
    let currentQuestion = {{ question_number }};
    
    // Initialize answered array
    let answered = new Array(totalQuestions + 1).fill(false);
    
    // Get elements
    const progressBar = document.getElementById('progressBar');
    const messageContainer = document.getElementById('messageContainer');
    
    // ===== Q1: INTERACTIVE BLANKS FUNCTIONALITY =====
    {% if question.question_type == 'fill_blanks' and question_number == 1 %}
    
    // Initialize answers object for Q1
    let fillBlanksAnswers = {
        1: null,  // blank 1 answer
        2: null,  // blank 2 answer
        3: null   // blank 3 answer
    };
    
    // Load previous answers if they exist
    document.addEventListener('DOMContentLoaded', function() {
        const previousAnswer = '{{ previous_answer|escapejs }}';
        if (previousAnswer) {
            const parts = previousAnswer.split(',').map(p => p.trim());
            parts.forEach((part, index) => {
                const blankNum = index + 1;
                if (part && blankNum <= 3) {
                    fillBlanksAnswers[blankNum] = part;
                    // Update UI
                    const blankSpace = document.getElementById(`blank${blankNum}`);
                    if (blankSpace) {
                        blankSpace.textContent = part;
                        blankSpace.classList.add('filled');
                    }
                    
                    // Mark the selected button
                    const selectedBtn = document.querySelector(`.option-btn[data-blank="${blankNum}"][data-value="${part}"]`);
                    if (selectedBtn) {
                        selectedBtn.classList.add('selected');
                    }
                }
            });
            updateAnswersPreview();
            updateHiddenField();
            checkAllBlanksFilled();
        }
    });
    
    // Add click handlers to all option buttons
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const blankNum = this.getAttribute('data-blank');
            const value = this.getAttribute('data-value');
            
            // Remove selected class from all buttons in this blank's container
            const container = this.closest('.options-row');
            container.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
            });
            
            // Add selected class to clicked button
            this.classList.add('selected');
            
            // Update the blank space
            const blankSpace = document.getElementById(`blank${blankNum}`);
            blankSpace.textContent = value;
            blankSpace.classList.add('filled');
            
            // Store the answer
            fillBlanksAnswers[blankNum] = value;
            
            // Update preview and hidden field
            updateAnswersPreview();
            updateHiddenField();
            
            // Check if all blanks are filled
            checkAllBlanksFilled();
            
            // Auto-save after selection
            setTimeout(() => autoSave(), 300);
        });
    });
    
    // Update the answers preview
    function updateAnswersPreview() {
        const previewSpan = document.getElementById('answersPreview');
        const answers = [];
        
        if (fillBlanksAnswers[1]) answers.push(fillBlanksAnswers[1]);
        if (fillBlanksAnswers[2]) answers.push(fillBlanksAnswers[2]);
        if (fillBlanksAnswers[3]) answers.push(fillBlanksAnswers[3]);
        
        if (answers.length === 0) {
            previewSpan.textContent = 'Not selected yet';
        } else {
            previewSpan.textContent = answers.join(', ');
        }
    }
    
    // Update hidden form field
    function updateHiddenField() {
        const hiddenField = document.getElementById('fillBlanksAnswer');
        if (hiddenField) {
            const answers = [
                fillBlanksAnswers[1] || '',
                fillBlanksAnswers[2] || '',
                fillBlanksAnswers[3] || ''
            ];
            hiddenField.value = answers.join(',');
        }
    }
    
    // Check if all blanks are filled
    function checkAllBlanksFilled() {
        if (fillBlanksAnswers[1] && fillBlanksAnswers[2] && fillBlanksAnswers[3]) {
            answered[currentQuestion] = true;
            updateDots();
        } else {
            answered[currentQuestion] = false;
            updateDots();
        }
    }
    
    // AutoSave for Q1
    function autoSave() {
        return new Promise((resolve, reject) => {
            if (!fillBlanksAnswers[1] || !fillBlanksAnswers[2] || !fillBlanksAnswers[3]) {
                resolve({success: true, message: 'Incomplete answers'});
                return;
            }
            
            const userAnswer = [
                fillBlanksAnswers[1],
                fillBlanksAnswers[2],
                fillBlanksAnswers[3]
            ].join(',');
            
            const formData = new FormData();
            formData.append('user_answer', userAnswer);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('{% url "writing:save_answer" test.id question_number %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    answered[currentQuestion] = true;
                    updateDots();
                    showMessage('success', ' Answer saved!');
                    resolve(data);
                } else {
                    reject(data.error);
                }
            })
            .catch(error => {
                reject(error);
            });
        });
    }
    
    function hasUserAnswered() {
        return fillBlanksAnswers[1] && fillBlanksAnswers[2] && fillBlanksAnswers[3];
    }
    
    {% elif question.question_type == 'sentence_order' and question_number == 2 %}
    
    // ===== Q2: ENHANCED DRAG AND DROP FUNCTIONALITY =====
    const sentences = [
        { letter: 'A', text: 'We submitted the assignment.' },
        { letter: 'B', text: 'The teacher explained the topic.' },
        { letter: 'C', text: 'The class started at ten.' }
    ];
    
    let currentOrder = ['A', 'B', 'C']; // Default to correct order
    let draggedItem = null;
    let dragOverItem = null;
    
    // Load previous answer if it exists
    document.addEventListener('DOMContentLoaded', function() {
        const previousAnswer = '{{ previous_answer|escapejs }}';
        if (previousAnswer) {
            const parts = previousAnswer.split(',').map(p => p.trim().toUpperCase());
            if (parts.length === 3 && parts.every(p => ['A', 'B', 'C'].includes(p))) {
                currentOrder = parts;
            }
        }
        
        renderSentences();
        updateHiddenField();
        updateOrderDisplay();
        checkAllSentencesArranged();
    });
    
    // Render sentences with enhanced drag and drop
    function renderSentences() {
        const container = document.getElementById('sentenceOrderContainer');
        container.innerHTML = '';
        
        currentOrder.forEach((letter, index) => {
            const sentence = sentences.find(s => s.letter === letter);
            if (!sentence) return;
            
            const card = document.createElement('div');
            card.className = 'sentence-card';
            card.setAttribute('data-letter', letter);
            card.setAttribute('data-index', index);
            card.setAttribute('draggable', 'true');
            
            card.innerHTML = `
                <span class="sentence-letter">${letter}</span>
                <span class="sentence-text">${sentence.text}</span>
                <span class="drag-handle">
                    <i class="fas fa-grip-vertical"></i>
                    <i class="fas fa-grip-lines"></i>
                </span>
            `;
            
            // Drag events
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('dragleave', handleDragLeave);
            card.addEventListener('drop', handleDrop);
            
            container.appendChild(card);
        });
    }
    
    function handleDragStart(e) {
        draggedItem = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.getAttribute('data-index'));
        
        // Create custom drag image
        const rect = this.getBoundingClientRect();
        const dragImage = this.cloneNode(true);
        dragImage.style.width = rect.width + 'px';
        dragImage.style.opacity = '0.7';
        dragImage.style.transform = 'scale(1.05)';
        dragImage.style.position = 'absolute';
        dragImage.style.top = '-1000px';
        document.body.appendChild(dragImage);
        e.dataTransfer.setDragImage(dragImage, e.offsetX, e.offsetY);
        setTimeout(() => document.body.removeChild(dragImage), 0);
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        draggedItem = null;
        
        // Remove all drag-over classes
        document.querySelectorAll('.sentence-card').forEach(card => {
            card.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
        });
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (this === draggedItem) return;
        
        const rect = this.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        // Remove previous classes
        this.classList.remove('drag-over-top', 'drag-over-bottom');
        
        // Add direction class based on mouse position
        if (e.clientY < midY) {
            this.classList.add('drag-over-top');
        } else {
            this.classList.add('drag-over-bottom');
        }
        
        this.classList.add('drag-over');
        dragOverItem = this;
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
    }
    
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
        
        if (!draggedItem || this === draggedItem) return;
        
        const draggedIndex = parseInt(draggedItem.getAttribute('data-index'));
        const targetIndex = parseInt(this.getAttribute('data-index'));
        
        // Reorder the array
        const [draggedLetter] = currentOrder.splice(draggedIndex, 1);
        currentOrder.splice(targetIndex, 0, draggedLetter);
        
        // Re-render
        renderSentences();
        
        // Update everything
        updateHiddenField();
        updateOrderDisplay();
        checkAllSentencesArranged();
        
        // Auto-save after drop
        autoSave();
    }
    
    function updateOrderDisplay() {
        const orderValue = document.getElementById('currentOrderValue');
        if (orderValue) {
            orderValue.textContent = currentOrder.join(', ');
        }
    }
    
    function updateHiddenField() {
        const hiddenField = document.getElementById('sentenceOrderAnswer');
        if (hiddenField) {
            hiddenField.value = currentOrder.join(',');
        }
    }
    
    function checkAllSentencesArranged() {
        if (currentOrder.length === 3) {
            answered[currentQuestion] = true;
            updateDots();
        }
    }
    
    function autoSave() {
        return new Promise((resolve, reject) => {
            const userAnswer = currentOrder.join(',');
            
            const formData = new FormData();
            formData.append('user_answer', userAnswer);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('{% url "writing:save_answer" test.id question_number %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    answered[currentQuestion] = true;
                    updateDots();
                    showMessage('success', ' Order saved!');
                    resolve(data);
                } else {
                    reject(data.error);
                }
            })
            .catch(error => {
                reject(error);
            });
        });
    }
    
    function hasUserAnswered() {
        return currentOrder.length === 3;
    }
    
    {% elif question.question_type == 'spelling_mcq' and question_number == 4 %}
    
    // ===== Q4: RADIO BUTTONS WITH SPECIFIED OPTIONS =====
    // Options as requested:
    // Q1: a) recieve b) receive c) recite d) receieve
    // Q2: a) definately b) definitely c) diffidently d) defenetly
    // Q3: a) seperate b) separate c) sepereta d) seprate
    
    // Define all options for each question
    const mcqQuestions = [
        {
            id: 1,
            correct: 'b',
            options: [
                { letter: 'a', text: 'recieve' },
                { letter: 'b', text: 'receive' },  // correct (b)
                { letter: 'c', text: 'recite' },
                { letter: 'd', text: 'receieve' }
            ]
        },
        {
            id: 2,
            correct: 'b',
            options: [
                { letter: 'a', text: 'definately' },
                { letter: 'b', text: 'defenetly' },  
                { letter: 'c', text: 'diffidently' },
                { letter: 'd', text: 'definitely' }    //correct d
            ]
        },
        {
            id: 3,
            correct: 'b',
            options: [
                { letter: 'a', text: 'separate' },  // correct a
                { letter: 'b', text: 'seperate' },  
                { letter: 'c', text: 'sepereta' },
                { letter: 'd', text: 'seprate' }
            ]
        }
    ];
    
    // Store selected answers
    let mcqSelectedAnswers = {
        1: null,
        2: null,
        3: null
    };
    
    // Load previous answers
    document.addEventListener('DOMContentLoaded', function() {
        const previousAnswer = '{{ previous_answer|escapejs }}';
        if (previousAnswer) {
            const parts = previousAnswer.split(',').map(p => p.trim().toLowerCase());
            parts.forEach((part, index) => {
                const qNum = index + 1;
                if (part && ['a', 'b', 'c', 'd'].includes(part)) {
                    mcqSelectedAnswers[qNum] = part;
                }
            });
        }
        
        renderMCQOptions();
        updateMCQHiddenField();
        checkAllMCQAnswered();
    });
    
    // Render options for all questions
    function renderMCQOptions() {
        mcqQuestions.forEach(q => {
            const container = document.getElementById(`q${q.id}-options`);
            if (!container) return;
            
            container.innerHTML = '';
            
            q.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `mcq-radio-option ${mcqSelectedAnswers[q.id] === option.letter ? 'selected' : ''}`;
                optionDiv.setAttribute('data-question', q.id);
                optionDiv.setAttribute('data-value', option.letter);
                
                optionDiv.innerHTML = `
                    <input type="radio" 
                           name="q${q.id}" 
                           value="${option.letter}" 
                           id="q${q.id}_${option.letter}"
                           ${mcqSelectedAnswers[q.id] === option.letter ? 'checked' : ''}>
                    <span class="option-letter">${option.letter})</span>
                    <span class="option-text">${option.text}</span>
                `;
                
                // Add click handler
                optionDiv.addEventListener('click', function(e) {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Remove selected class from all options in this question
                    document.querySelectorAll(`[data-question="${q.id}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to this option
                    this.classList.add('selected');
                    
                    // Update selected answer
                    mcqSelectedAnswers[q.id] = option.letter;
                    
                    // Update hidden field
                    updateMCQHiddenField();
                    checkAllMCQAnswered();
                    
                    // Auto-save after selection
                    setTimeout(() => autoSave(), 300);
                });
                
                container.appendChild(optionDiv);
            });
        });
    }
    
    // Update hidden field
    function updateMCQHiddenField() {
        const hiddenField = document.getElementById('mcqAnswers');
        if (hiddenField) {
            const answers = [
                mcqSelectedAnswers[1] || '',
                mcqSelectedAnswers[2] || '',
                mcqSelectedAnswers[3] || ''
            ];
            hiddenField.value = answers.join(',');
        }
    }
    
    // Check if all questions answered
    function checkAllMCQAnswered() {
        if (mcqSelectedAnswers[1] && mcqSelectedAnswers[2] && mcqSelectedAnswers[3]) {
            answered[currentQuestion] = true;
            updateDots();
        } else {
            answered[currentQuestion] = false;
            updateDots();
        }
    }
    
    // AutoSave for Q4
    function autoSave() {
        return new Promise((resolve, reject) => {
            if (!mcqSelectedAnswers[1] || !mcqSelectedAnswers[2] || !mcqSelectedAnswers[3]) {
                resolve({success: true, message: 'Incomplete answers'});
                return;
            }
            
            const userAnswer = [
                mcqSelectedAnswers[1],
                mcqSelectedAnswers[2],
                mcqSelectedAnswers[3]
            ].join(',');
            
            const formData = new FormData();
            formData.append('user_answer', userAnswer);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('{% url "writing:save_answer" test.id question_number %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    answered[currentQuestion] = true;
                    updateDots();
                    showMessage('success', ' Answers saved!');
                    resolve(data);
                } else {
                    reject(data.error);
                }
            })
            .catch(error => {
                reject(error);
            });
        });
    }
    
    function hasUserAnswered() {
        return mcqSelectedAnswers[1] && mcqSelectedAnswers[2] && mcqSelectedAnswers[3];
    }
    
    {% else %}
    
    // Regular functions for other questions
    function updateWordCount() {
        const textarea = document.getElementById('userAnswer');
        if (textarea) {
            const text = textarea.value.trim();
            const words = text ? text.split(/\s+/).length : 0;
            document.getElementById('wordCount').textContent = words;
        }
    }
    
    function autoSave() {
        return new Promise((resolve, reject) => {
            const userAnswer = document.getElementById('userAnswer')?.value.trim() || '';
            
            if (!userAnswer) {
                resolve({success: true, message: 'No answer to save'});
                return;
            }
            
            const formData = new FormData();
            formData.append('user_answer', userAnswer);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('{% url "writing:save_answer" test.id question_number %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    answered[currentQuestion] = true;
                    updateDots();
                    showMessage('success', ' Answer saved!');
                    resolve(data);
                } else {
                    reject(data.error);
                }
            })
            .catch(error => {
                reject(error);
            });
        });
    }
    
    function hasUserAnswered() {
        const textarea = document.getElementById('userAnswer');
        return textarea && textarea.value.trim() !== '';
    }
    
    {% endif %}
    
    // Common functions for all questions
    document.addEventListener('DOMContentLoaded', function() {
        {% if question.question_type == 'fill_blanks' and question_number == 1 %}
            // Q1 handled in its own block
        {% elif question.question_type == 'sentence_order' and question_number == 2 %}
            // Q2 handled in its own block
        {% elif question.question_type == 'spelling_mcq' and question_number == 4 %}
            // Q4 handled in its own block
        {% else %}
            updateWordCount();
        {% endif %}
        
        // Get answered questions from server
        const answeredQuestions = {{ answered_questions|safe }};
        
        if (answeredQuestions && Array.isArray(answeredQuestions)) {
            answeredQuestions.forEach(qNum => {
                if (qNum >= 1 && qNum <= totalQuestions) {
                    answered[qNum] = true;
                }
            });
        }
        
        updateDots();
        updateProgressBar();
    });
    
    function showMessage(type, text) {
        messageContainer.classList.remove('hidden', 'success', 'warning');
        
        const icon = messageContainer.querySelector('i');
        const span = messageContainer.querySelector('span');
        
        if (type === 'success') {
            messageContainer.classList.add('success');
            icon.className = 'fas fa-check-circle';
            span.textContent = text || ' Saved!';
        } else if (type === 'warning') {
            messageContainer.classList.add('warning');
            icon.className = 'fas fa-exclamation-triangle';
            span.textContent = text || ' Please answer this question first';
        }
        
        setTimeout(() => {
            messageContainer.classList.add('hidden');
        }, 3000);
    }
    
    function pulseRed(questionNum) {
        const dot = document.getElementById(`dot-${questionNum}`);
        if (dot) {
            dot.classList.add('pulse-red');
            setTimeout(() => {
                dot.classList.remove('pulse-red');
            }, 500);
        }
    }
    
    function updateDots() {
        for (let i = 1; i <= totalQuestions; i++) {
            const dot = document.getElementById(`dot-${i}`);
            if (!dot) continue;
            
            dot.classList.remove('active', 'answered');
            
            if (i === currentQuestion) {
                dot.classList.add('active');
            } else if (answered[i]) {
                dot.classList.add('answered');
            }
        }
    }
    
    function updateProgressBar() {
        const progress = (currentQuestion / totalQuestions) * 100;
        progressBar.style.width = progress + '%';
    }
    
    window.jumpToQuestion = function(num) {
        window.location.href = '{% url "writing:writing_question" test.id 0 %}'.replace('0', num);
    };
    
    window.handleNextClick = function() {
        {% if question.question_type == 'fill_blanks' and question_number == 1 %}
        const userAnswered = fillBlanksAnswers[1] && fillBlanksAnswers[2] && fillBlanksAnswers[3];
        {% elif question.question_type == 'sentence_order' and question_number == 2 %}
        const userAnswered = currentOrder && currentOrder.length === 3;
        {% elif question.question_type == 'spelling_mcq' and question_number == 4 %}
        const userAnswered = mcqSelectedAnswers[1] && mcqSelectedAnswers[2] && mcqSelectedAnswers[3];
        {% else %}
        const userAnswered = hasUserAnswered();
        {% endif %}
        
        if (!userAnswered && !answered[currentQuestion]) {
            showMessage('warning', ' Please answer this question first');
            pulseRed(currentQuestion);
            return;
        }
        
        autoSave().then(() => {
            const nextUrl = '{% url "writing:writing_question" test.id 0 %}'.replace('0', currentQuestion + 1);
            window.location.href = nextUrl;
        }).catch(() => {
            const nextUrl = '{% url "writing:writing_question" test.id 0 %}'.replace('0', currentQuestion + 1);
            window.location.href = nextUrl;
        });
    };
    
    window.handleSubmitClick = function() {
        {% if question.question_type == 'fill_blanks' and question_number == 1 %}
        const userAnswered = fillBlanksAnswers[1] && fillBlanksAnswers[2] && fillBlanksAnswers[3];
        {% elif question.question_type == 'sentence_order' and question_number == 2 %}
        const userAnswered = currentOrder && currentOrder.length === 3;
        {% elif question.question_type == 'spelling_mcq' and question_number == 4 %}
        const userAnswered = mcqSelectedAnswers[1] && mcqSelectedAnswers[2] && mcqSelectedAnswers[3];
        {% else %}
        const userAnswered = hasUserAnswered();
        {% endif %}
        
        if (!userAnswered && !answered[currentQuestion]) {
            showMessage('warning', ' Please answer this question before submitting');
            pulseRed(currentQuestion);
            return;
        }
        
        autoSave().then(() => {
            document.getElementById('answerForm').submit();
        }).catch(() => {
            document.getElementById('answerForm').submit();
        });
    };
</script>
{% endblock %}